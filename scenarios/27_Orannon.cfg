#textdomain wesnoth-A_New_Order
[scenario]
    name = _ "Orannon"
    id=27_Orannon
    # important note: do not change the map at range: { x=40 y=1-31 }
    map_data="{~add-ons/A_New_Order/maps/Orannon.map}"
    next_scenario=28_Lorin
    {INTRO_AND_SCENARIO_MUSIC battle/onethousandsuns.ogg battle-epic.ogg}
    {EXTRA_SCENARIO_MUSIC battle/through_the_gates.ogg}
    {EXTRA_SCENARIO_MUSIC theme_of_a_new_order.ogg}
    turns=unlimited # (was written as "-1" previously but I find "unlimited" to be clearer)
    [story]
        [part]
            story=_"Gawen and his army marched out of Vattin. Bor Cryne wasn't waiting - realizing that his only chance was to join with Grekulak's hordes advancing from the east, he left his hideout with all forces he could muster... but by this time, many Akladian lords and the greater part of the orcs had already abandoned him."
            background=story_images/generic_hills-01.png
        [/part]
        [part]
            story=_"Both forces met at the fields which were later called Orannon, which in Akladian means 'battlefield'. This day was to be remembered for many generations to come - and also by vultures and jackals, who couldn't expect to see such an abundant number of bodies again for decades."
            background=story/landscape-battlefield.jpg
        [/part]
    [/story]
    {DAWN}
    {MORNING}
    {AFTERNOON}
    {DUSK}
    {FIRST_WATCH}
    {SECOND_WATCH}
    victory_when_enemies_defeated=yes # TODO: ...or maybe not? See note on "victory" event...

#define AVOID_INVULNERABLES
    # (to be placed inside [ai][/ai] tags)
#ifdef DEBUG_MODE
#ifdef USE_GOAL_TO_AVOID
    [goal]
        [criteria] #NOTE: this is a SUF, because we're targeting a unit
            [not]
                status=invulnerable
            [/not]
            [and]
                [not]
                    [filter_wml]
                        [status]
                            invulnerable=yes
                        [/status]
                    [/filter_wml]
                [/not]
            [/and]
        [/criteria]
        value=234 # (might be too high, which is why I have this half ifdef-ed out)
    [/goal]
#else
    [avoid]
        [filter]
            status=invulnerable
            [or]
                [filter_wml]
                    [status]
                        invulnerable=yes
                    [/status]
                [/filter_wml]
            [/or]
        [/filter]
    [/avoid]
#endif
#endif
#enddef

    # You:
    [side]
        controller=human
        id=Gawen Hagarthen
        name=_"Gawen Hagarthen"
        team_name=good
        type=Young Hagarthen
        profile=portraits/gawen_matured.png
        canrecruit=yes
        unrenamable=yes
        side=1
        facing=nw
        recruit=Akladian Wiseman,Akladian Clansman,Akladian Warrior
        shroud=yes
        # Player should already have a large amount of gold, so keeping it small here is fine:
        {GOLD4 120 110 100 90}
        {INCOME4 9 6 3 0}
    [/side]

    {BUFF_AKLADIAN_HEALERS}

    # Your allied AI side:
    [side]
        controller=ai
        id=Huon Ryedric
        save_id=Huon Ryedric
        persistent=yes
        name=_"Huon Ryedric"
        type=General
        profile=portraits/huon.png
        team_name=good
        canrecruit=yes
        side=2
        facing=ne
        # Spearman = fighter, Javelineer = fighter, Bowman = archer, Peasant = fighter, Swordsman = fighter, Mage = mixed fighter, Pikeman = fighter
        recruit=Spearman,Javelineer,Bowman,Peasant,Swordsman,Mage,White Mage,Pikeman
        {INCOME4 10 9 8 7}
        {GOLD4 330 295 260 225}
        [ai]
            passive_leader=yes
            recruitment_pattern=fighter,fighter,fighter,healer,fighter,archer,mixed fighter
            caution=0.25
            aggression=0.5
            grouping=defensive
        [/ai]
        [ai]
            time_of_day=dusk,first_watch,second_watch
            aggression=0.2
            caution=0.8
            grouping=no
        [/ai]
    [/side]

    # Northwest Akladians:
    [side]
        side=3
        id=Bor Cryne
        name=_"Bor Cryne"
        controller=ai
        canrecruit=yes
        team_name=bad
        facing=se
        type=Lord Bor Cryne
        recruit=Akladian Warrior,Akladian Light Infantry,Akladian Sturmknight,Akladian Darknite,Akladian Raider,Akladian Pikeneer,Akladian Wonderman
        {GOLD4 240 270 300 330}
        {INCOME4 5 7 9 11}
        {ANO_ENEMY_LEADER_TRAITS}
        [ai]
            {NO_SCOUTS}
            recruitment_pattern=fighter,1,fighter,healer,fighter,2,fighter
            aggression=0.6
            caution={ON_DIFFICULTY4 0.21 0.14 0.07 0.00}
            grouping=offensive
            passive_leader=yes
            leader_value=6
            [goal]
                [criteria] #NOTE: this is a SUF, because we're targeting a unit
                    id=Gawen Hagarthen
                [/criteria]
                value={ON_DIFFICULTY4 50 75 100 125}
            [/goal]
            [goal]
                [criteria] #NOTE: this is a SUF, because we're targeting a unit
                    id=Lady Lorin
                [/criteria]
                value={ON_DIFFICULTY4 50 75 100 125}
            [/goal]
        [/ai]
        [ai]
            time_of_day=dawn,morning,afternoon
            caution=0.3
            aggression=0.6
            grouping=offensive
        [/ai]
        [ai]
            time_of_day=dusk,first_watch,second_watch
            caution={ON_DIFFICULTY4 0.21 0.14 0.07 0.00}
            aggression={ON_DIFFICULTY4 0.7 0.8 0.9 1.0}
            grouping=no
        [/ai]
    [/side]

    # Western orcs, just north of Huon Ryedric:
    [side]
        controller=ai
        id=Borlug
        name=_"Borlug"
        type=Orcish Sovereign
        team_name=bad
        canrecruit=yes
        side=4
        facing=se
#ifdef EASY
        recruit=Orcish Warrior,Wolf Rider,Orcish Archer,Troll,Goblin Pillager,Goblin Knight,Orcish Shaman
#else
        recruit=Orcish Warrior,Wolf Rider,Orcish Crossbowman,Troll,Goblin Pillager,Goblin Knight,Orcish Shaman
#endif
        {GOLD4 230 250 270 290}
        {INCOME4 4 5 6 7}
        [ai]
            recruitment_pattern=fighter,scout,fighter,archer,fighter,scout,fighter,scout,fighter,mixed fighter,fighter
            caution=0.75
            aggression=0.2
            grouping=defensive
#ifdef EASY
            simple_targeting=yes
#endif
        [/ai]
        [ai]
            time_of_day=dusk,first_watch,second_watch
            aggression=0.5
            caution={ON_DIFFICULTY4 0.21 0.14 0.07 0.00}
            grouping=no
        [/ai]
    [/side]

    # Nearby central-ish Akladians:
    [side]
        controller=ai
        id=Uri van Roe
        name=_"Uri van Roe"
        type=Akladian Lord
        team_name=bad
        canrecruit=yes
        side=5
        facing=sw
#ifdef EASY
        recruit=Akladian Wonderman,Akladian Warrior,Akladian Light Infantry,Akladian Darknite,Akladian Sturmknight,Akladian Raider
#else
        recruit=Akladian Wonderman,Akladian Pikeneer,Akladian Warrior,Akladian Light Infantry,Akladian Darknite,Akladian Sturmknight,Akladian Raider,Akladian Fastfoot
#endif
        {GOLD4 260 300 340 380}
        {INCOME4 8 10 12 14}
        {ANO_ENEMY_LEADER_TRAITS}
        [ai]
            recruitment_pattern=fighter,1,fighter,healer,fighter
#ifdef EASY
            [goal]
                [criteria] #NOTE: this is a SUF, because we're targeting a unit
                    id=Gawen Hagarthen
                [/criteria]
                value=75
            [/goal]
#else
            [goal]
                [criteria] #NOTE: this is a SUF, because we're targeting a unit
                    id=Gawen Hagarthen
                [/criteria]
                value=100
            [/goal]
            [goal]
                [criteria] #NOTE: this is a SUF, because we're targeting a unit
                    id=Lady Lorin
                [/criteria]
                value=100
            [/goal]
            {AVOID_INVULNERABLES}
#endif
        [/ai]
        [ai]
            time_of_day=dawn,morning,afternoon
            caution=0.3
            aggression=0.6
            grouping=offensive
        [/ai]
        [ai]
            time_of_day=dusk,first_watch,second_watch
            caution={ON_DIFFICULTY4 0.21 0.14 0.07 0.00}
            aggression=1.0
            grouping=no
        [/ai]
    [/side]

    # Nearby south-central-ish outlaws:
    [side]
        side=6
        id=Robert the Hefty
        name=_"Robert the Hefty"
        controller=ai
        canrecruit=yes
        team_name=bad
        facing=sw
        type=Fugitive
        # bandit = fighter, outlaw = mixed fighter, huntsman = archer, brigand = scout, highwayman = fighter, trapper = archer, ranger = mixed fighter
        recruit=Bandit,Outlaw,Huntsman,Brigand,Highwayman,Trapper,Ranger
        {GOLD4 280 300 320 340}
        {INCOME4 5 6 7 8}
        [modifications]
            # "Hefty" = large and muscular, i.e. both slow and strong:
            {TRAIT_SLOW}
            {TRAIT_STRONG}
        [/modifications]
        [ai]
            recruitment_pattern=fighter,mixed fighter,fighter,archer,fighter,archer,fighter,mixed fighter,fighter,scout,fighter
        [/ai]
        [ai]
            time_of_day=dusk,first_watch,second_watch
            aggression={ON_DIFFICULTY4 0.42 0.46 0.50 0.54} # 0.4 is the default, so keep this higher, but only slightly
            caution={ON_DIFFICULTY4 0.21 0.14 0.07 0.00}
            grouping=no
        [/ai]
        [ai]
            time_of_day=dawn,morning,afternoon
            aggression={ON_DIFFICULTY4 0.3 0.2 0.1 0.0}
            caution=0.75
            grouping=defensive
        [/ai]
    [/side]

    # Southeast undead (appear with Grekulak):
    [side]
        controller=ai
        id=Mal-Raylal
        name=_"Mal-Raylal"
        type=Necromancer
        # soul = scout, blood bat = scout, ghost = scout, revenant = fighter, dark adept = archer
#ifdef EASY
        # Mal-Raylal gets L0 Souls because he is a weaker necromancer; do NOT give them to Grekulak:
        recruit=Soul,Blood Bat,Ghost,Revenant,Dark Adept
#else
#ifdef NORMAL
        # vampire bat = scout, shadow = scout, wraith = scout
        recruit=Soul,Vampire Bat,Shadow,Wraith,Revenant,Dark Adept
#else
        # (HARD or NIGHTMARE) spectre = scout
        recruit=Soul,Vampire Bat,Shadow,Wraith,Revenant,Spectre,Dark Adept
#endif
#endif
        team_name=bad
        canrecruit=yes
        side=7
        facing=sw
        {GOLD4 240 260 280 300}
        {INCOME4 6 8 10 12}
        [modifications]
            {TRAIT_WEAK}
            {TRAIT_LOYAL OVERLAY=""}
            {TRAIT_INTELLIGENT}
        [/modifications]
        [ai]
            # OK, this seems to work fine now:
            recruitment_pattern=fighter,scout,fighter,archer,fighter,scout,0
            [goal]
                [criteria] #NOTE: this is a SUF, because we're targeting a unit
                    id=Gawen Hagarthen
                [/criteria]
                value={ON_DIFFICULTY4 75 100 125 150}
            [/goal]
            [goal]
                [criteria] #NOTE: this is a SUF, because we're targeting a unit
                    id=Lady Lorin
                [/criteria]
                value={ON_DIFFICULTY4 75 100 125 150}
            [/goal]
            [goal]
                [criteria] #NOTE: this is a SUF, because we're targeting a unit
                    id=Ruvio
                [/criteria]
                value={ON_DIFFICULTY4 75 100 125 150}
            [/goal]
#ifdef NIGHTMARE
            [goal]
                name=target_location
                [criteria] #NOTE: this is a SLF, because we're targeting a location
                    x,y=20,27 # Gawen's starting keep (where Lorin has to be withdrawn to)
                [/criteria]
                value=111
            [/goal] #
            {AVOID_INVULNERABLES}
#endif
        [/ai]
        [ai]
            time_of_day=dawn,morning,afternoon
            caution=0.3
            aggression=0.6
            grouping=offensive
        [/ai]
        [ai]
            time_of_day=dusk,first_watch,second_watch
            caution={ON_DIFFICULTY4 0.21 0.14 0.07 0.00}
            aggression={ON_DIFFICULTY4 0.7 0.8 0.9 1.0}
            grouping=no
        [/ai]
    [/side]

    # Central east undead (appear on turn 13):
    [side]
        controller=ai
        id=Grekulak
        name=_"Grekulak"
        type=Ancient Lich
        profile=portraits/grekulak.png
        # skeleton = fighter, chocobone = scout, bone shooter = archer, necrophage = fighter, revenant = fighter
#ifdef EASY
        recruit=Skeleton,Chocobone,Bone Shooter,Necrophage,Revenant
#else
#ifdef NORMAL
        # banebow = archer, draug = fighter
        recruit=Skeleton,Chocobone,Banebow,Necrophage,Revenant,Draug
#else
        # (HARD or NIGHTMARE) ghast = fighter, death knight = fighter
        recruit=Skeleton,Chocobone,Banebow,Necrophage,Ghast,Revenant,Draug,Death Knight
#endif
#endif
        team_name=bad
        canrecruit=yes
        side=8
        facing=sw
        {GOLD4 200 250 300 350}
        {INCOME4 10 15 20 25}
        [modifications]
            {TRAIT_RESILIENT}
            {TRAIT_INTELLIGENT}
            [object]
                silent=yes
                id=Grekulak_terror
                duration=forever
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_TERROR}
                    [/abilities]
                [/effect]
            [/object]
        [/modifications]
        [ai]
            # This pattern is probably fine here for now, considering that it'll
            # need to be changed in the turn 16 event anyways (see below)...
            recruitment_pattern=fighter,scout,fighter,archer,fighter,2,fighter
            [goal]
                [criteria] #NOTE: this is a SUF, because we're targeting a unit
                    id=Gawen Hagarthen
                [/criteria]
                value={ON_DIFFICULTY4 75 100 125 150}
            [/goal]
            [goal]
                [criteria] #NOTE: this is a SUF, because we're targeting a unit
                    id=Lady Lorin
                [/criteria]
                value={ON_DIFFICULTY4 75 100 125 150}
            [/goal]
            [goal]
                [criteria] #NOTE: this is a SUF, because we're targeting a unit
                    id=Ruvio
                [/criteria]
                value={ON_DIFFICULTY4 75 100 125 150}
            [/goal]
#ifdef NIGHTMARE
            [goal]
                [criteria] #NOTE: this is a SUF, because we're targeting a unit
                    id=Huon Ryedric
                [/criteria]
                value=111
            [/goal] #
            [goal]
                name=protect_unit
                [criteria] #NOTE: this is a SUF, because we're protecting a unit
                    id=Grekulak
                [/criteria]
                protect_radius=6 # MP of an Ancient Lich
                value=42
            [/goal] #
            {AVOID_INVULNERABLES}
#endif
        [/ai]
        [ai]
            time_of_day=dawn,morning,afternoon
            caution=0.3
            aggression=0.6
            grouping=offensive
        [/ai]
        [ai]
            time_of_day=dusk,first_watch,second_watch
            caution={ON_DIFFICULTY4 0.21 0.14 0.07 0.00}
            aggression={ON_DIFFICULTY4 0.7 0.8 0.9 1.0}
            grouping=no
        [/ai]
    [/side]

    # Northeast orcs (appear with Grekulak):
    [side]
        controller=ai
        id=Warh Arug
        name=_"Warh Arug"
        type=Orcish Sovereign
        team_name=bad
        canrecruit=yes
        side=9
        facing=sw
        # orcish warrior = fighter, wolf rider = scout, orcish archer = archer, troll = fighter, goblin pillager = scout, goblin knight = scout, orcish shaman = mixed fighter, orcish slayer = mixed fighter, orcish warlord = fighter
#ifdef EASY
        recruit=Orcish Warrior,Wolf Rider,Orcish Archer,Troll,Goblin Pillager,Goblin Knight,Orcish Shaman,Orcish Slayer,Orcish Warlord
#else
        # direwolf rider = scout, orcish crossbowman = archer, troll warrior = fighter, orcish slurbow = archer
        recruit=Orcish Warrior,Direwolf Rider,Orcish Crossbowman,Troll,Goblin Pillager,Goblin Knight,Orcish Shaman,Orcish Slayer,Troll Warrior,Orcish Slurbow,Orcish Warlord
#endif
        {GOLD4 240 260 280 300}
        {INCOME4 3 4 5 6}
        [ai]
#ifdef EASY
            recruitment_pattern=fighter,scout,fighter,archer,fighter,scout,fighter,scout,fighter,mixed fighter,fighter,mixed fighter,fighter
#else
            recruitment_pattern=fighter,scout,fighter,archer,fighter,scout,fighter,scout,fighter,mixed fighter,fighter,mixed fighter,fighter,archer,fighter
#endif
            caution=0.75
            aggression=0.2
            grouping=defensive
#ifdef EASY
            simple_targeting=yes
#endif
        [/ai]
        [ai]
            time_of_day=dusk,first_watch,second_watch
            aggression=0.5
            caution={ON_DIFFICULTY4 0.21 0.14 0.07 0.00}
            grouping=no
        [/ai]
    [/side]
    # allied starting villages:
    {STARTING_VILLAGES 2 {ON_DIFFICULTY4 8 7 6 5}} # Huon Ryedric
    # enemy starting villages:
    {STARTING_VILLAGES 3 {ON_DIFFICULTY4 12 14 16 18}} # Bor Cryne
    {STARTING_VILLAGES 4 {ON_DIFFICULTY4 6 7 8 9}} # Borlug
    {STARTING_VILLAGES 5 {ON_DIFFICULTY4 6 7 8 9}} # Uri van Roe
    {STARTING_VILLAGES 6 {ON_DIFFICULTY4 9 10 11 12}} # Robert the Hefty

#undef AVOID_INVULNERABLES

    # wmllint: recognize Reme Carrenemoe
    # wmllint: recognize Lady Lorin
    # wmllint: recognize Deorien
    # wmllint: recognize Ruvio
    # wmllint: recognize Reumario
    [event]
        name=prestart
        [store_gold]
            side=1
            variable=ano_gawen_gold
        [/store_gold]
        {VARIABLE ano_trap_first yes}
        {VARIABLE ano_bridge_questions yes}
        {VARIABLE_OP ano_gawen_gold add {ON_DIFFICULTY4 -700 -600 -500 -400}}
        {VARIABLE ano_lorin_in_castle no}
        # To made it harder for those with A LOT of gold
        {IF ano_gawen_gold greater_than 0}
        {VARIABLE_OP ano_gawen_gold multiply {ON_DIFFICULTY4 0.06 0.08 0.10 0.12}}
        [gold]
            side=3 # Bor Cryne
            amount=$ano_gawen_gold
        [/gold]
        [gold]
            side=8 # Grekulak
            amount=$ano_gawen_gold
        [/gold]
        {END_IF_WITHOUT_ELSE}
        [store_unit]
            [filter]
                id=Grekulak
            [/filter]
            kill=yes
            variable=ano_grekulak
        [/store_unit]
        [store_unit]
            [filter]
                id=Warh Arug
            [/filter]
            kill=yes
            variable=ano_warh
        [/store_unit]
        [store_unit]
            [filter]
                id=Mal-Raylal
            [/filter]
            kill=yes
            variable=ano_rayl
        [/store_unit]
        {RECALLXY (Lady Lorin) 19 27}
        {IF_HAVE_UNIT_ANY (Reme Carrenemoe)}
        {RECALLXY (Reme Carrenemoe) 21 27}
        {ELSE}
        {IF_HAVE_UNIT_ANY (Reumario)}
        {RECALLXY (Reumario) 21 27}
        {ELSE}
#ifdef NIGHTMARE
        [terrain]
            x,y=21,27
            layer=overlay
            terrain="^Edb"
        [/terrain]
#else
        {GENERIC_UNIT 1 Peasant 21 27}
#endif
        {TWO_END_IFs}
        {RECALLXY (Deorien) 19 28}
        {RECALLXY (Ruvio) 20 26}
#ifdef EASY
        {GENERIC_UNIT 1 Bowman 20 28}
        {IF_NOT_HAVE_CREATE_LOYAL 1 (Bowman) 20 28}
        {GENERIC_UNIT 1 Spearman 21 28}
        {IF_NOT_HAVE_CREATE_LOYAL 1 (Spearman) 21 28}
#endif
#ifdef NORMAL
        # slightly weaker:
        {IF_NOT_HAVE_CREATE_LOYAL 1 (Peasant) 20 28}
        {IF_NOT_HAVE_CREATE_LOYAL 1 (Peasant) 21 28}
#endif # NORMAL
        [modify_unit]
            [filter]
                side=1
            [/filter]
            facing=nw
        [/modify_unit]
        [store_locations]
            x,y=40,1-31
            terrain=Gg
            variable=ano_tg
        [/store_locations]
        [store_locations]
            x,y=40,1-31
            terrain=Re
            variable=ano_tr
        [/store_locations]
        [store_locations]
            x,y=40,1-31
            terrain=Gs^Fp
            variable=ano_tf
        [/store_locations]
        [store_locations]
            x,y=40,1-31
            terrain=Ss
            variable=ano_tw
        [/store_locations]
        [store_locations]
            x,y=40,1-31
            terrain=Gg^Vh
            variable=ano_tv
        [/store_locations]
        [store_locations]
            x,y=40,1-31
            terrain=Ce
            variable=ano_tn
        [/store_locations]
        [store_locations]
            x,y=40,1-31
            terrain=Rd
            variable=ano_te
        [/store_locations]
        {CLEAR_VARIABLE ano_tmp}
        {VARIABLE ano_tmp 1}
        {WHILE ano_tmp less_than 31}
        [terrain]
            x=40
            y=$ano_tmp
            terrain=Xu
        [/terrain]
        {VARIABLE_OP ano_tmp add 1}
        {END_WHILE}
        [remove_shroud]
            side=1
            x,y=0-40,0-31
        [/remove_shroud]
        [place_shroud]
            side=1
            x,y=40-45,1-30
        [/place_shroud]
    [/event]

    # A battlecry to give this more the feel of a final battle:
    [event]
        name=attack
        [filter]
            side=1
            [not]
                id=Gawen Hagarthen
            [/not]
            [not]
                id=Lady Lorin
            [/not]
            [not]
                id=Ruvio
            [/not]
            [not]
                id=Deorien
            [/not]
            [not]
                id=Reme Carrenemoe
            [/not]
            [not]
                id=Reumario
            [/not]
            [not]
                # maybe simplify as just "race=akladian"? (since we are in a [not][/not] tag)
                type=Akladian Clansman,Akladian Warrior,Akladian Light Infantry,Akladian Pikeneer,Akladian Fastfoot,Wiseman,Akladian Wonderman,Akladian Raider,Akladian Homeguard,Akladian Protector,Akladian Darknite,Akladian Shieldguard,Akladian Sturmknight
            [/not]
        [/filter]
        {MSG_unit _"Remember the Freetown!"}
    [/event]

    # There are more reminders to protect Huon further below; I dunno why this one is up here:
    [event]
        name=attack
        [filter_second]
            id=Huon Ryedric
        [/filter_second]
        {MSG_Huon _"I am personally under attack! I need help NOW!"}
        [gold]
            side=2
            amount={ON_DIFFICULTY4 60 41 22 3}
        [/gold]
        [modify_side]
            side=2
            # Keep this higher than their initial income of {10 9 8 7}:
            {INCOME4 20 18 16 14}
        [/modify_side]
    [/event]

    # Opening dialogue:
    [event]
        name=start
        {IF_HAVE_UNIT (Reme Carrenemoe)}
        {MSGm_Reme _"My lord, our scouts report that Grekulak is much closer than we thought. He is just four days' march from here - or two days for an undead army, since they can march without rest night and day."}
        {ELSE}
        {MSGm_Ruvio _"My lord, our scouts report that Grekulak is much closer than we thought. He is just four days' march from here - or two days for an undead army, since they can march without rest night and day."}
        {END_IF}
        {MODIFY_UNIT (id=Gawen Hagarthen) facing ne}
        {MSGa_Gawen _"Two days? It's impossible to defeat them within two days."}
        {MSGm_Lorin _"Then we must kill as many of them as possible and choose a good defensive position until Grekulak's army arrives."}
        {MSG_Deorien _"Indeed. We will have no time to rest and cure our wounded. But perhaps it won't be necessary, we should negotiate first..."}
        {MSG_Cryne _"Hey, who's there? The little boy with his mommy?"}
        {MODIFY_UNIT (id=Gawen Hagarthen) facing nw}
        {MSGa_Gawen _"Bor Cryne - finally we meet on the field of combat. You will answer to me for everything you have done."}
        {MSG_Cryne _"Oh, I'm so scared. And isn't that the famous rebel leader, Ruvio? Such a coward he abandoned his family in Freetown when he heard we were coming for them."}
        {MSGm_Ruvio _"My lord... please... grant me this, I pray you. I want to kill him. Leave him to me."}
        {MSG_Cryne _"I wish you were as pretty as your daughters, Ruvio. I'd do to you the same thing I did to them. Especially the redhead, what was her name? The fighting one. She was the best!"}
        {REPLACE_SCENARIO_MUSIC battle/fragments_of_time_cut.ogg}
        {APPEND_MUSIC battle/onethousandsuns.ogg}
        {APPEND_MUSIC battle/ambuscade.ogg}
        {APPEND_MUSIC battle/battlecry.ogg}
        {APPEND_MUSIC northerners.ogg}
        {APPEND_MUSIC weight_of_revenge.ogg}
        {MSGa_Gawen _"Kill them. Kill them all. Have no mercy."}
        {MSG_Deorien _"My lord, we really should try negotiations first. Grekulak is enemy of everyone, and..."}
        {MSGa_Gawen _"Remember the Freetown! Remember the Freetown! Kill them all!"}
        [objectives]
            side=1
#ifndef NIGHTMARE
            #po: this hint is only present on EASY, NORMAL, and HARD, but not NIGHTMARE, though:
            note=_"In this scenario, only Gawen and Lorin have full interrogations for enemy leaders."
#endif
            [objective]
                description=_"Kill all enemy leaders"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Gawen Hagarthen"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Lady Lorin"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Deorien"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Ruvio"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Huon Ryedric"
                condition=lose
            [/objective]
            {IS_LAST_SCENARIO}
            {HAS_NO_TURN_LIMIT}
        [/objectives]
    [/event]

    # next macro is from macros/debug.cfg; contains an "ifdef DEBUG_MODE" preprocessor conditional:
    {SET_SCENARIO_STATUS_TO (
        [option]
            # po: debug option; completes sentence starting with "Set scenario status to...":
            message=_"Grekulak's arrival."
            [command]
                [fire_event]
                    name=turn 13
                    id=Grekulak_arrives
                [/fire_event]
            [/command]
        [/option]
        [option]
            # po: debug option; completes sentence starting with "Set scenario status to...":
            message=_"Grekulak's attempt at spreading darkness."
            [command]
                [fire_event]
                    name=turn 16
                    id=Grekulak_darkens
                [/fire_event]
            [/command]
        [/option]
    )}

    # Luc and Gauri's appearance on victory:
    [event]
        # FIXME: this can be reached before Grekulak arrives...
        name=victory
        {IF ano_grekulak_come not_equals yes}
        # XXX: ??? (some sort of message like the ones in the Battle of Barnon?)
        {END_IF_WITHOUT_ELSE}
        [move_unit_fake]
            side=2
            x=13,13,14,15
            y=30,29,28,29
            type=Akladian Protector
        [/move_unit_fake]
        [unit]
            side=2
            id=Lucs
            name=_"Lucs"
            x=16
            y=27
            type=Akladian Protector
        [/unit]
        [move_unit_fake]
            side=2
            x=13,13,14
            y=30,29,28
            type=Akladian Lord
        [/move_unit_fake]
        [unit]
            side=2
            id=Luc Hagarthen
            name=_"Luc Hagarthen"
            profile=portraits/luc.png
            x=15
            y=28
            type=Akladian Lord
        [/unit]
        [move_unit_fake]
            side=2
            x=13,13,14
            y=30,29,28
            type=Akladian Lord
        [/move_unit_fake]
        [unit]
            side=2
            id=Gauri Hagarthen
            name=_"Gauri Hagarthen"
            profile=portraits/gauri.png
            x=14
            y=28
            type=Akladian Lord
        [/unit]
        [unit]
            side=2
            id=Lucs
            name=_"Lucs"
            x=17
            y=28
            type=Akladian Protector
        [/unit]
        [unit]
            side=2
            id=Lucs
            name=_"Lucs"
            x=13
            y=29
            type=Akladian Protector
        [/unit]
        [unit]
            side=2
            id=Lucs
            name=_"Lucs"
            x=13
            y=30
            type=Akladian Protector
        [/unit]
        {MESSAGE (Luc Hagarthen) (portraits/luc.png) (_"Luc Hagarthen") _"Aww, we're too late! Our cousin had all the fun and left nothing for us!"}
        {MESSAGE (Gauri Hagarthen) (portraits/gauri.png) (_"Gauri Hagarthen") _"We would have been here earlier, if not for you, brother!"}
        {MESSAGE (Luc Hagarthen) (portraits/luc.png) (_"Luc Hagarthen") _"Me? And who wanted to check whether the wine in Vakladia tastes different than in Guilcorta?"}
        {MESSAGE (Gauri Hagarthen) (portraits/gauri.png) (_"Gauri Hagarthen") _"And what about the girls in that town?"}
        {MSGa_Gawen _"Who are you? Friend or foe?"}
        {MESSAGE (Luc Hagarthen) (portraits/luc.png) (_"Luc Hagarthen") _"We are Luc and Gauri Hagarthen, your loyal swords from Guilcorta, your cousins, dear... uhmm... how should we address you, your majesty, cousin, or maybe... messiah?"}
        {MSGa_Gawen _"'My king' would be enough. You are welcomed here, even if a bit late."}

        {CLEAR_VARIABLE ano_gawen_units}
        [store_unit]
            [filter]
                side=1
                # TODO: double-check that this list includes all level 3 (or higher) units that Gawen could possibly have:
                type=Akladian Darknite,Akladian Fastfoot,Akladian Pikeneer,Akladian Protector,Akladian Wonderman,Fugitive,Highwayman,Dune Wayfarer,Dune Marauder,Dune Windbolt,Dune Harrier,Dune Cataphract,Dune Spearmaster,Huntsman,Ranger,Silver Mage,Royal Guard,Master at Arms,Master Bowman,Mage of Light,Iron Mauler,Halberdier,Arch Mage,Great Mage,Dune Warmaster,Dune Blademaster,Dune Firetrooper,General,Grand Marshal,Assassin,Dune Luminary,Elvish Sharpshooter,Elvish Avenger,Elvish Marshal,Elvish Champion,Elvish Outrider,Elvish Shyde,Elvish Enchantress,Elvish Sylph
            [/filter]
            variable=ano_level_three
            kill=no
        [/store_unit]
        [unstore_unit]
            variable="ano_lorin_stored"
            find_vacant=yes
        [/unstore_unit]
#ifdef COUNT_REGULAR_UNITS_TOWARDS_SCORE_TOO
        [store_unit]
            [filter]
                side=1
            [/filter]

            kill=no
            variable=ano_gawen_units
        [/store_unit]
        {NEXT_SCENARION_VICTORY (victory) (ano_29)}
#endif
    [/event]

#ifdef EARLY_VICTORY
    [event]
        name=turn 13
        [endlevel]
            result=victory
            bonus=no
        [/endlevel]
    [/event]
#endif

    # In case Huon dies:
    [event]
        name=last breath
        [filter]
            id=Huon Ryedric
            side=2
        [/filter]
        {MSG_Huon _"Aaargh! I haven't avenged my family!"}
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    # Grekulak's arrival:
    [event]
        # TODO: now that this event is fireable via a debug menu, ensure that it is idempotent:
        # (well, actually, I guess we don't really need to worry about that unless we also set first_time_only=no on it...)
        name=turn 13
        id=Grekulak_arrives
        [unstore_unit]
            variable=ano_grekulak
        [/unstore_unit]
        [unstore_unit]
            variable=ano_warh
        [/unstore_unit]
        [unstore_unit]
            variable=ano_rayl
        [/unstore_unit]
        {FOREACH ano_tg i}
            {VARIABLE_OP ano_tmpx to_variable ano_tg[$i].x}
            {VARIABLE_OP ano_tmpy to_variable ano_tg[$i].y}
            [terrain]
                x=$ano_tmpx
                y=$ano_tmpy
                terrain=Gg
            [/terrain]
        {NEXT i}
        {CLEAR_VARIABLE i}
        {CLEAR_VARIABLE ano_tg}
        {FOREACH ano_tr i}
            {VARIABLE_OP ano_tmpx to_variable ano_tr[$i].x}
            {VARIABLE_OP ano_tmpy to_variable ano_tr[$i].y}
            [terrain]
                x=$ano_tmpx
                y=$ano_tmpy
                terrain=Re
            [/terrain]
        {NEXT i}
        {CLEAR_VARIABLE i}
        {CLEAR_VARIABLE ano_tr}
        {FOREACH ano_tf i}
            {VARIABLE_OP ano_tmpx to_variable ano_tf[$i].x}
            {VARIABLE_OP ano_tmpy to_variable ano_tf[$i].y}
            [terrain]
                x=$ano_tmpx
                y=$ano_tmpy
                terrain=Gs^Fp
            [/terrain]
        {NEXT i}
        {CLEAR_VARIABLE i}
        {CLEAR_VARIABLE ano_tf}
        {FOREACH ano_tw i}
            {VARIABLE_OP ano_tmpx to_variable ano_tw[$i].x}
            {VARIABLE_OP ano_tmpy to_variable ano_tw[$i].y}
            [terrain]
                x=$ano_tmpx
                y=$ano_tmpy
                terrain=Ss
            [/terrain]
        {NEXT i}
        {CLEAR_VARIABLE i}
        {CLEAR_VARIABLE ano_tw}
        {FOREACH ano_tv i}
            {VARIABLE_OP ano_tmpx to_variable ano_tv[$i].x}
            {VARIABLE_OP ano_tmpy to_variable ano_tv[$i].y}
            [terrain]
                x=$ano_tmpx
                y=$ano_tmpy
                terrain=Gg^Vh
            [/terrain]
        {NEXT i}
        {CLEAR_VARIABLE i}
        {CLEAR_VARIABLE ano_tv}
        {FOREACH ano_tn i}
            {VARIABLE_OP ano_tmpx to_variable ano_tn[$i].x}
            {VARIABLE_OP ano_tmpy to_variable ano_tn[$i].y}
            [terrain]
                x=$ano_tmpx
                y=$ano_tmpy
                terrain=Ce
            [/terrain]
        {NEXT i}
        {CLEAR_VARIABLE i}
        {CLEAR_VARIABLE ano_tn}
        {FOREACH ano_te i}
            {VARIABLE_OP ano_tmpx to_variable ano_te[$i].x}
            {VARIABLE_OP ano_tmpy to_variable ano_te[$i].y}
            [terrain]
                x=$ano_tmpx
                y=$ano_tmpy
                terrain=Rd
            [/terrain]
        {NEXT i}
        {CLEAR_VARIABLE i}
        {CLEAR_VARIABLE ano_te}
        {CLEAR_VARIABLE ano_tmpx}
        {CLEAR_VARIABLE ano_tmpy}
#ifdef NIGHTMARE
        {CAPTURE_VILLAGES_OF_TYPE Gd^Vhr 7 43 24 6}
        {CAPTURE_VILLAGES_OF_TYPE Gd^Vhr 8 41 14 4}
        [terrain]
            x,y=41,3
            terrain=Re^Vct
        [/terrain]
        [terrain]
            x,y=44,4
            terrain=Rd^Vct
        [/terrain]
        [terrain]
            x,y=44,1
            terrain=Gg^Vct
        [/terrain]
        [terrain]
            x,y=45,3
            terrain=Gs^Vct
        [/terrain]
        {CAPTURE_VILLAGES_OF_TYPE *^Vct 9 43 3 3}
#endif
        {VARIABLE ano_grekulak_come yes}

        #HORDE OF GREKULAK
        # ("G" is for "Grekulak")
#define GZOMBIE X Y
    {VARIABLE_OP ano_N add 1}
    [unit]
        side=8
#ifdef NIGHTMARE
        type=Soulless
#else
        type=Walking Corpse
#endif
        id="Zombie $ano_N"
        x={X}
        y={Y}
        [modifications]
            {TRAIT_LOYAL}
            {TRAIT_UNDEAD}
#ifdef EASY
            {TRAIT_SLOW}
#else
            {TRAIT_STRONG}
#endif
        [/modifications]
    [/unit]
#enddef
        {VARIABLE ano_N 0}
        {GZOMBIE 38 12}
        {GZOMBIE 39 12}
        {GZOMBIE 39 15}
        {GZOMBIE 41 13}
        {GZOMBIE 41 17}
        {GZOMBIE 41 25}
        {GZOMBIE 43 12}
        {GZOMBIE 43 14}
        {GZOMBIE 44 9}
        {GZOMBIE 44 15}
        {GZOMBIE 44 19}
        {GZOMBIE 44 22}
        {GZOMBIE 44 26}
#ifdef HARD
        {GZOMBIE 39 13}
        {GZOMBIE 44 13}
        {GZOMBIE 40 16}
#endif
        {CLEAR_VARIABLE ano_N}
        {CLEAR_VARIABLE ano_trap_first} #trap is only to slow player a bit until Grekulak will come...
        {PLACE_IMAGE (items/bones.png) 39 14}
        {PLACE_IMAGE (items/bones.png) 43 15}
        {PLACE_IMAGE (items/bones.png) 44 10}
        {PLACE_IMAGE (items/bones.png) 39 11}
        {PLACE_IMAGE (scenery/trash.png) 43 10}
        {PLACE_IMAGE (scenery/village-human-burned4.png) 44 9}

#ifdef NIGHTMARE
        # Give Grekulak more easy zombie fodder:
        {ALLOW_RECRUIT 2 ("Woodsman,Ruffian") }
#else
        # Deny Grekulak easy zombie fodder:
        {DISALLOW_RECRUIT 2 ("Peasant") }
#endif
        [remove_shroud]
            x,y=0-46,0-31
            side=1
        [/remove_shroud]
        {MSG_Cryne _"Ha ha! Now you are doomed!"}
        [scroll_to]
            x,y=41,14
            highlight=yes
        [/scroll_to]
        {REPLACE_SCENARIO_MUSIC into_the_shadows.ogg} # FIXME: this might not actually be the best choice for this particular moment... maybe something more epic, threatening, and scary-sounding?
        {APPEND_MUSIC battle-epic.ogg}
        {APPEND_MUSIC knalgan_theme.ogg}
        {APPEND_MUSIC the_deep_path.ogg}
        {APPEND_MUSIC battle/fragments_of_time_cut.ogg}
        {APPEND_MUSIC battle/onethousandsuns.ogg}
        {APPEND_MUSIC battle/ambuscade.ogg}
        {APPEND_MUSIC battle/battlecry.ogg}
        {APPEND_MUSIC battle/through_the_gates.ogg}
        {APPEND_MUSIC theme_of_a_new_order.ogg}
        {APPEND_MUSIC northerners.ogg}
        {APPEND_MUSIC weight_of_revenge.ogg}
        {MSG_Grekulak _"I am your new messiah. Recognise me as your lord now and you shall be spared. Try to oppose me and you will be killed and raised as my mindless slaves."}
        #po: Hint that Huon's recruits have changed:
        {MSG_Huon _"Never, foul lich! We may have to adjust our tactics, but we shall never surrender!"}
        {MSG_Deorien _"Lady Lorin, are you sure you can participate in a battle?"}
        {MSGm_Lorin _"And why not, foul and rude mage?"}
        {MSG_Deorien _"As I said before, I KNOW. I also know that ANY effort may be extremely dangerous for you."}
        {MSGm_Lorin _"First of all, I am LORIN, foul mage. Second of all, I am not a Wesnothian woman, the kind you are used to, but Akladian. I can fight until... for as long as I want."}
        {MSG_Deorien _"My king, please take my advice. Order Lorin to withdraw into the castle. No matter how she boasts and flaunts her Akladian heritage, I am quite sure she shouldn't be here."}
        {MSGa_Gawen _"But why? I don't understand. Lorin is a fine warrior, and withdrawing her from battle may be..."}
        {MSG_Deorien _"I am a mage attuned to life, my king, and can sense things you cannot. Believe me, withdraw her into our keep."}
        {MSGm_Lorin _"FOUL mage. You should have said: 'I am a FOUL mage'."}
        [objectives]
            side=1
#ifndef NIGHTMARE
            #po: this hint is only present on EASY, NORMAL, and HARD, but not NIGHTMARE, though:
            note=_"In this scenario, only Gawen and Lorin have full interrogations for enemy leaders."
#endif
            [objective]
                description=_"Kill all enemy leaders"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Gawen Hagarthen"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Lady Lorin"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Deorien"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Ruvio"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Huon Ryedric"
                condition=lose
            [/objective]
            {IS_LAST_SCENARIO}
        [/objectives]
    [/event]

    # Grekulak tries a spell:
    [event]
        name=turn 16
        id=Grekulak_darkens
        first_time_only=no #for firing via the debug menu
        {IF ano_grekulak_come equals yes}
        {REPLACE_SCENARIO_MUSIC suspense.ogg}
        {APPEND_MUSIC into_the_shadows.ogg}
        {APPEND_MUSIC battle-epic.ogg}
        {APPEND_MUSIC knalgan_theme.ogg}
        {APPEND_MUSIC the_deep_path.ogg}
        {APPEND_MUSIC battle/fragments_of_time_cut.ogg}
        {APPEND_MUSIC battle/onethousandsuns.ogg}
        {APPEND_MUSIC battle/ambuscade.ogg}
        {APPEND_MUSIC battle/battlecry.ogg}
        {APPEND_MUSIC battle/through_the_gates.ogg}
        {APPEND_MUSIC theme_of_a_new_order.ogg}
        {APPEND_MUSIC northerners.ogg}
        {APPEND_MUSIC weight_of_revenge.ogg}
        #po: This incantation that Grekulak tries should sound (or at least look) poetic:
        {MSG_Grekulak _"
Forces of Darkness, come to my aid -

Let there be eternal night;

Let your eyes become blind -

Forces of Darkness will consume your mind."}
#define TREMOR
    # macro from HttT
    [scroll]
        x=5
        y=0
    [/scroll]
    [delay]
        time=10
    [/delay]
    [scroll]
        x=-10
        y=0
    [/scroll]
    [delay]
        time=10
    [/delay]
    [scroll]
        x=0
        y=5
    [/scroll]
    [delay]
        time=10
    [/delay]
    [scroll]
        x=0
        y=-10
    [/scroll]
#enddef
#define COC R G B
    [color_adjust]
        red={R}
        green={G}
        blue={B}
    [/color_adjust]
    [delay]
        # FIXME: maybe this is too much?
        time=25
    [/delay]
#enddef
        {TREMOR}
        {TREMOR}
        # I think the issue here is that since these are (well, were) all the same value, it doesn't
        # look like anything is happening? Maybe the original intent was to have them as relative
        # values rather than absolute values? Anyways, varying the numbers a bit is kinda noticeable;
        # maybe vary them more...
        {COC (30) (-20) (-20)}
        {COC (30) (-20) (-21)}
        {COC (30) (-21) (-20)}
        {COC (31) (-20) (-20)}
        {COC (30) (-21) (-21)}
        {COC (31) (-21) (-20)}
        {COC (31) (-20) (-21)}
        {COC (31) (-21) (-21)}
        {COC (30) (-20) (-22)}
        {COC (30) (-22) (-20)}
        {COC (32) (-20) (-20)}
        {COC (30) (-21) (-22)}
        {COC (31) (-22) (-20)}
        {COC (32) (-20) (-21)}
        {COC (31) (-20) (-22)}
        {COC (30) (-22) (-21)}
        {COC (32) (-21) (-20)}
        {COC (31) (-21) (-22)}
        {COC (31) (-22) (-21)}
        {COC (32) (-21) (-21)}
        {COC (31) (-21) (-21)}
        {COC (0) (0) (0)}
        [redraw]
        [/redraw]
        [delay]
            time=10
        [/delay]
        [place_shroud]
            x,y=0-46,0-31
            side=1
        [/place_shroud]
        [redraw]
        [/redraw]
        [delay]
            time=10
        [/delay]
        {MSG_Deorien _"NO! Avaunt, the darkness, avaunt, the night!"}
        # TODO: maybe change music again?
        # FIXME: I'm not sure if this works properly...
        {COC (-30) (20) (20)}
        {COC (-30) (20) (21)}
        {COC (-30) (21) (20)}
        {COC (-31) (20) (20)}
        {COC (-30) (21) (21)}
        {COC (-31) (21) (20)}
        {COC (-31) (20) (21)}
        {COC (-31) (21) (21)}
        {COC (-30) (20) (22)}
        {COC (-30) (22) (20)}
        {COC (-32) (20) (20)}
        {COC (-30) (21) (22)}
        {COC (-31) (22) (20)}
        {COC (-32) (20) (21)}
        {COC (-31) (20) (22)}
        {COC (-30) (22) (21)}
        {COC (-32) (21) (20)}
        {COC (-31) (21) (22)}
        {COC (-31) (22) (21)}
        {COC (-32) (21) (21)}
        {COC (-31) (21) (21)}
        [remove_shroud]
            x,y=0-46,0-31
            side=1
        [/remove_shroud]
        {MSG_Grekulak _"How is this possible? Who could possibly have broken my sorcery?"}
        {MSG_Deorien _"Even a child could have done it, it was so weak... as is all of your heinous black magic; for all your power has been built solely on lies and deceit."}
        {MSG_Grekulak _"Brave words - and who dares to utter them?"}
        #po: please preserve the cheesy rhyming here on translation, so that Grekulak's reply calling Deorien an "awful poet" makes sense:
        {MSG_Deorien _"Deorien, mage of light - whose might will defeat the night."}
        {MSG_Grekulak _"You are a competent enough mage, but an awful poet. Deorien, you will be mine before this battle is through."}
#ifdef NIGHTMARE
        [modify_unit]
            [filter]
                id=Grekulak
            [/filter]
            [object]
                silent=yes
                id=Grekulak_obscures
                duration=forever
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_OBSCURES}
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=halo
                    halo=halo/dark-aura.png
                [/effect]
            [/object]
        [/modify_unit]
#endif
        {ELSE}
#ifdef DEBUG_MODE
        {IF_DEBUG_MODE_IS_ACTUALLY_ON}
        {DEBUGMSG1 "Firing this event (Grekulak_darkens) with debug mode won't work until Grekulak has come!"}
        {ELSE}
        {DEBUGMSG1 "You shouldn't be seeing this event now! A prerequisite event hasn't happened yet!"}
        {END_IF}
#else
        [redraw][/redraw]
#endif
        {END_IF}
    [/event]

    # Reminder to withdraw Lorin:
    [event]
        name=turn 18
        # LADY LORIN HAS TO BE WITHDRAWN INTO THE CASTLE WITHIN 6 turns
        {OPVAL ("Lady Lorin") (hitpoints) (add) (-100)}
        {MSGm_Lorin _"Aaaah!"}
        {MSGa_Gawen _"What happened? Mother?"}
        {MSGm_Lorin _"It's nothing... It's nothing... I just... I can't..."}
        {MSG_Deorien _"Ahem."}
        {MSGm_Lorin _"Shut up, mage. I will fight, I just have to rest for a moment..."}
        {MSG_Deorien _"No, you CAN'T. My lord, you must withdraw Lorin to our castle's keep immediately. She is unable to fight any longer."}
        [store_unit]
            [filter]
                id=Lady Lorin
            [/filter]
            variable=ano_lorin_stored
            kill=no
        [/store_unit]
        {VARIABLE_OP ano_tmp_x to_variable ano_lorin_stored.x}
        {VARIABLE_OP ano_tmp_y to_variable ano_lorin_stored.y}
        {IF ano_tmp_x equals 20}
        {IF ano_tmp_y equals 27}
        {MSGm_Lorin _"I AM in the castle's keep, you idiot."}
        {MSG_Deorien _"Good. Now, go to bedroom. I will send someone to take care of you immediately."}
        {VARIABLE ano_lorin_in_castle yes}
        [store_unit]
            [filter]
                id=Lady Lorin
            [/filter]
            variable=ano_lorin_stored
            kill=yes
        [/store_unit]
        {ELSE}
        {MSGm_Lorin _"Shut up, I can fight, I just have to get some rest!"}
        {MSG_narrator _"You have to withdraw Lady Lorin to your initial castle's keep within 6 turns."}
        {VARIABLE ano_lorin_pregnant yes}
        {END_IF}
        {ELSE}
        {MSGm_Lorin _"Shut up, I can fight, I just have to get some rest!"}
        {MSG_narrator _"You have to withdraw Lady Lorin to your initial castle's keep within 6 turns."}
        {VARIABLE ano_lorin_pregnant yes}
        {END_IF}
    [/event]

    # Trap:
    [event]
        name=moveto
        first_time_only=no #it is to make sure player will be slowed down before Grekulak's entrance...
        [filter]
            side=1
            x,y=14-22,3-7
        [/filter]
        # Only the first time should have an actual trap:
        {IF ano_trap_first equals yes}
        {MSG_Cryne _"Are you prepared for a little surprise? Get them boys!"}
        {UNIT 3 (Akladian Darknite) $x1 $y1 (id=Hidden Dragon 1)}
        {UNIT 3 (Akladian Darknite) $x1 $y1 (id=Hidden Dragon 2)}
        {VARIABLE ano_trap_first no}
        {ELSE}
        [gold]
            amount={ON_DIFFICULTY4 1 2 3 4} # (just a little bit, so that there's an actual point to setting first_time_only=no, without actually being too much of a pain)
            side=3 # Bor Cryne
        [/gold]
        {END_IF}
    [/event]

    # WIP: I want units who move next to bridges to be able to destroy them:
    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            [filter_location]
                [not]
                    terrain=*^Bw*
                [/not]
                [filter_adjacent_location]
                    terrain=*^Bw*
                [/filter_adjacent_location]
            [/filter_location]
            [not]
                # Ensure he isn't talking to himself:
                id=Gawen Hagarthen
            [/not]
        [/filter]
        {IF ano_bridge_questions equals yes}
        [if]
            [variable]
                name=unit.id
                equals=Lady Lorin
            [/variable]
            [then]
                {MSGm_Lorin _"Gawen, I'm going to destroy this bridge."}
                {VARIABLE ano_opt yes}
            [/then]
            [else]
                [message]
                    speaker=unit
                    message= _"Milord, should I destroy this bridge?"
                [/message]
                # FIXME: change "any bridges" to "any more bridges" when one has already been destroyed,
                # and also adjust "today" based on passage of time (scenario usually lasts more than one day):
                {MSGOPTI3 (Gawen Hagarthen) (portraits/gawen_matured.png)
                (_"Well...")
                (_"Yes!") (yes)
                (_"No, but I might want a bridge destroyed later...") (no1)
                (_"No, we won't be destroying any bridges today.") (no2)
                }
            [/else]
        [/if]
        {IF ano_opt equals yes}
        [scroll_to_unit]
            id=$unit.id
        [/scroll_to_unit]
        [animate_unit]
            flag=attack
            [filter]
                id=$unit.id
            [/filter]
            [primary_attack]
                range=melee
            [/primary_attack]
            [facing]
                [filter_adjacent_location]
                    x,y=$unit.x,$unit.y
                [/filter_adjacent_location]
                [and]
                    terrain=*^Bw*
                [/and]
            [/facing]
            hits=yes
        [/animate_unit]
        [animate_unit]
            flag=attack
            [filter]
                id=$unit.id
            [/filter]
            [primary_attack]
                range=melee
            [/primary_attack]
            [facing]
                [filter_adjacent_location]
                    x,y=$unit.x,$unit.y
                [/filter_adjacent_location]
                [and]
                    terrain=*^Bw*
                [/and]
            [/facing]
            hits=yes
        [/animate_unit]
        [sound]
            name=cave-in.ogg
        [/sound]
        [sound]
            name=water-blast.wav
        [/sound]
        [terrain]
            [filter_adjacent_location]
                x,y=$unit.x,$unit.y
            [/filter_adjacent_location]
            [and]
                terrain=*^Bw*
            [/and]
            terrain=Ww^Es
        [/terrain]
        [message]
            speaker=unit
            message=_"Ha, take that!"
        [/message]
        {ELSE_IF ano_opt equals no1}
        [message]
            speaker=unit
            message= _"OK, I won't this time, but I really think we should destroy some bridges eventually, so I'll keep asking!"
        [/message]
        {ELSE} # no2
        {VARIABLE ano_bridge_questions no}
        [message]
            speaker=unit
            message=_"In that case I shall cease asking to do so."
        [/message]
        {TWO_END_IFs}
        {END_IF_WITHOUT_ELSE}
        # TODO: only allow this to be done to single-tile-long bridges; prevent it from firing on the 2nd tile of the 2-tile-long one
    [/event]

#define SETUPPABLE_OUTPOST _X _Y
    [event]
        name=moveto
        [filter]
            side=1
            x,y={_X},{_Y}
        [/filter]
        [message]
            speaker=unit
            message=_"Let me set up an outpost here."
        [/message]
        [terrain]
            x,y={_X},{_Y}
            terrain=Ce
        [/terrain]
    [/event]
#enddef
    {SETUPPABLE_OUTPOST 20 20}
    {SETUPPABLE_OUTPOST 27 24}
#ifdef EASY
    {SETUPPABLE_OUTPOST 12 19}
    {SETUPPABLE_OUTPOST 14 19}
#endif

    # Lorin withdraws:
    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Lady Lorin
            x,y=20,27
        [/filter]
        {IF ano_lorin_pregnant equals yes}
        {CLEAR_VARIABLE ano_lorin_pregnant}
        {MSGm_Lorin _"I really can fight!"}
        #po: "Note for translators: 'But what about IT?' refers to Lorin's child"
        {MSG_Deorien _"Yes, you can fight. But what about IT?"}
        {MSGa_Gawen _"IT?"}

        {VARIABLE ano_lorin_in_castle yes}
        [store_unit]
            [filter]
                id=Lady Lorin
            [/filter]
            variable=ano_lorin_stored
            kill=yes
        [/store_unit]
        {ELSE}
        # XXX: ???
        {END_IF}
    [/event]

    # Consequence of failing to withdraw Lorin in time:
    [event]
        name=turn 24
        {IF ano_lorin_in_castle equals no}
        {MSGm_Lorin _"Aaah! I can't handle this pain!"}
        {MSGa_Gawen _"What happened? What?"}
        {MSG_Deorien _"I told you... she miscarried."}
        {MSGa_Gawen _"She WHAT?"}
        {MSGm_Lorin _"Noooooo!"}
        [endlevel]
            result=defeat
        [/endlevel]
        {ELSE}
        {MSGa_Gawen _"I wish Lorin were still here to fight alongside us; we could use her help..."}
        {MSG_Deorien _"Trust me, Gawen, it is for the better that she is in the castle right now."}
        {END_IF}
#ifdef NIGHTMARE
        [event]
            name=new turn
            {IF turn_number greater_than 24}
            [modify_side]
                side=8
                # Income for this side on NIGHTMARE difficulty is usually 25, and the first new turn after turn 24 where this will fire
                # will be turn 25, so this should always be an increase over that:
                income="$(turn_number + 1)"
                # should always be an increase over the default of 1:
                village_gold="$(turn_number - 24)"
            [/modify_side]
            {END_IF_WITHOUT_ELSE}
        [/event]
#endif
    [/event]

    # Reminder to protect Huon Ryedric:
    [event]
        name=die
        first_time_only=no
        [filter]
            side=2
            x=1-13
            y=18-30
        [/filter]
        {VARIABLE_OP ano_side_two add 1}
        {IF ano_side_two equals 4}
        {MSG_Huon _"My king, we could really use some help here."}
        [gold]
            side=2
            amount={ON_DIFFICULTY4 30 21 12 3}
        [/gold]
        {ELSE_IF ano_side_two equals 8}
        {MSG_Huon _"We are under heavy assault, my king. We really could use some help here."}
        [gold]
            side=2
            amount={ON_DIFFICULTY4 30 21 12 3}
        [/gold]
        {END_IF_WITHOUT_ELSE}
        {END_IF}
    [/event]

    # To ensure Grekulak is able to keep his assault up:
    [event]
        # Wait this is the same turn as the darkening event... why not combine them?
        name=turn 16
        id=Grekulak_new_recruits
        [gold]
            amount={ON_DIFFICULTY4 40 50 60 70}
            side=8 # Grekulak
        [/gold]
        # Deathblade = fighter, Banebow = archer, Draug = fighter
        {ALLOW_RECRUIT 8 ("Deathblade,Banebow,Draug")}
#ifdef NIGHTMARE
        # Lich = fighter
        {ALLOW_RECRUIT 8 ("Lich")}
#endif
        [modify_side]
            side=8
            [ai]
                recruitment_pattern=fighter,archer,fighter,archer,fighter,2,fighter,3,fighter
            [/ai]
        [/modify_side]
    [/event]

    {ALL_ANO_DEATHS}
    {ELVISH_DEATHS}
    {MAGE_DEATHS}
    {ELVISH_KILLING}
    # A good portion of this scenario's code is actually in this FINAL_INTERROGATIONS macro;
    # it is located in macros/ano-20macros.cfg:
    {FINAL_INTERROGATIONS}
[/scenario]
