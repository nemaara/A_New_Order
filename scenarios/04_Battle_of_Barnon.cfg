#textdomain wesnoth-A_New_Order

#define END_OF_BARNON_CLEANUP
    [store_unit]
        [filter]
            side=1
            canrecruit=yes
        [/filter]
        variable=ano_gawen
        kill=yes
    [/store_unit]
    [store_unit]
        [filter]
            [not]
                canrecruit=yes
            [/not]
            side=1
        [/filter]
        variable=ano_prisoned
        kill=yes
    [/store_unit]
    # FIXME: validator says keys in here are invalid:
    [modify_side]
        side=1
        current_player=_"Lady Lorin"
        save_id="Lady Lorin"
    [/modify_side]
    {CLEAR_RECALL}
    {CLEAR_VARIABLE ano_lorin_via}
    {CLEAR_VARIABLE ano_reme_via}
#enddef

[scenario]
    name = _ "Battle of Barnon"
    id=04_Battle_of_Barnon
    map_data="{~add-ons/A_New_Order/maps/Barnon.map}"
    {INTRO_AND_SCENARIO_MUSIC battle-epic.ogg the_city_falls.ogg}
    {EXTRA_SCENARIO_MUSIC battle/gameplay06.ogg}
    {TURNS4 24 22 20 18} # becomes unlimited later
    {COUNT_DEATHS_PERSISTENT ano_barnon_dejavu ano_barnon_deaths}
    [story]
        [part]
            story=_"After few days of preparation, the first-born sons of the Akladian lords appeared in Vattin. They became guests of King Gawen Hagarthen and his step-mother Lady Lorin. He, accompanied by two lords and a small army, marched north to the settlements of the clan of Barnon."
        [/part]
        [part]
            story=_"Hoyre O Barnon did not trust the Wesnothians living in the city of Barnon. Fearing that the citizens would open the gates to Gawen Hagarthen, he withdrew to his castle in the forests nearby. Indeed, the city of Barnon surrendered easily, though the citizens didn't show any signs of enthusiasm."
            background=story_images/story_barnon.png
        [/part]
        [part]
            story=_"It was at this moment that Gawen realized that he was as hated by Wesnothian folk as by Akladians. The former considered him a barbarian beast and a tyrant, and the latter called him mixling - at best. The irony of this realization was so overwhelming that he began to laugh. He probably would have laughed even harder if he had heard some of his warriors; they whispered that Gawen was laughing in anticipation of the battle, and their esteem for him rose dramatically."
        [/part]
    [/story]
    {DAWN}
    {MORNING}
    {AFTERNOON}
    {DUSK}
    {FIRST_WATCH}
    {SECOND_WATCH}
    victory_when_enemies_defeated=no
    [side]
        controller=human
        id=Gawen Hagarthen
        name=_"Gawen Hagarthen"
        team_name=good
        type=Young Hagarthen
        profile=portraits/gawen.png
        canrecruit=yes
        unrenamable=yes
        side=1
        # Look, I get that this scenario is supposed to be hard, but it also gets boring testing it so many times
        # with such a small selection of units for recruiting... Maybe we could add something else here?
        # Not a unit that would make it easier, just something to make it more interesting...
        recruit=Akladian Wiseman,Akladian Clansman,Akladian Warrior
        {INCOME4 4 3 2 1}
        {GOLD4 140 130 120 110} # keep this lower than 150 so that Reme's dialogue below always has a chance to fire (i.e., in the case in which the player is entering the scenario with no gold)
    [/side]

    {BUFF_AKLADIAN_HEALERS}

    [side]
        side=2
        id=Hoyre O Barnone
        name=_"Hoyre O Barnone"
        controller=ai
        canrecruit=yes
        team_name=bad
        type=Akladian Lord
        facing=se
        profile=portraits/hoyre.png
        recruit=Akladian Clansman,Akladian Warrior,Akladian Light Infantry,Akladian Raider,Akladian Sturmknight
        {GOLD4 140 160 180 200}
        # this income is modified later; see "new turn" event below:
        {INCOME4 7 9 11 14} # (I violated the pattern due to triskaidekaphobia)
        [ai]
            passive_leader=yes
            grouping=defensive
            aggression=0.0
            caution=0.99
            [goal]
                name=protect_unit
                [criteria]
                    side=2
                    canrecruit=yes
                [/criteria]
                protect_radius={ON_DIFFICULTY4 6 7 8 9}
                value={ON_DIFFICULTY4 9 8 7 6}
            [/goal]
            [goal]
                name=protect_location
                [criteria]
                    x,y=20,3 # Same as label for Castle of Barnon set below
                [/criteria]
                protect_radius={ON_DIFFICULTY4 7 8 9 10}
                value={ON_DIFFICULTY4 8 7 6 5}
            [/goal]
            turns={ON_DIFFICULTY4 (1-5) (1-4) (1-3) (1-2)}
        [/ai]
        [ai]
            passive_leader=yes
            passive_leader_shares_keep=yes
            grouping=offensive
            caution=0.0
            aggression=0.5
            [goal]
                name=target_location
                [criteria]
                    x,y=22,19 # Same as label for City of Barnon set below
                [/criteria]
                value={ON_DIFFICULTY4 7 8 9 10}
            [/goal]
            turns={ON_DIFFICULTY4 (6-99) (5-88) (4-77) (3-36)}
        [/ai]
        [ai]
            [avoid]
                x,y=21,21 # Gawen's keep, so that Uri can take it
            [/avoid]
            turns=15-30
        [/ai] #

        [unit]
            id="Oeme"
            name=_"Oeme"
            type=Akladian Clansman
            x=17
            y=10
            ai_special=guardian
            facing=se
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]
#ifdef NORMAL
        [unit]
            id="Moro"
            name=_"Moro"
            type=Akladian Clansman
            x=18
            y=10
            ai_special=guardian
            facing=se
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]
#endif
#ifdef HARD
        [unit]
            id="Moro"
            name=_"Moro"
            type=Akladian Warrior
            x=18
            y=10
            ai_special=guardian
            facing=se
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]
#endif
#ifdef NIGHTMARE
        [unit]
            id="Moro"
            name=_"Moro the Strong"
            type=Akladian Light Infantry
            x=18
            y=10
            # (not a guardian on this difficulty)
            facing=se
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_STRONG}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]
#endif # NIGHTMARE
        [unit]
            id="Moreo"
            name=_"Moreo"
            type=Akladian Clansman
            x=21
            y=11
            ai_special=guardian
            facing=sw
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_STRONG}
            [/modifications]
        [/unit]
#ifdef HARD
        [unit]
            id="Nome"
            name=_"Nome"
            type=Akladian Clansman
            x=20
            y=10
            ai_special=guardian
            facing=sw
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_QUICK}
            [/modifications]
        [/unit]
#endif
#ifdef NIGHTMARE
        [unit]
            id="Nome"
            name=_"Nome, the Highlander"
            type=Akladian Warrior
            x=20
            y=10
            # (not a guardian on this difficulty)
            facing=sw
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_QUICK}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit] #
#endif # NIGHTMARE
    [/side]
    [side]
        side=3
        id=Bor Cryne
        name=_"Bor Cryne"
        controller=ai
        canrecruit=yes
        team_name=good
        type=Lord Bor Cryne
        facing=ne
        # (all fighters)
        recruit=Akladian Clansman,Akladian Warrior,Akladian Light Infantry,Akladian Sturmknight,Akladian Darknite,Akladian Raider,Akladian Pikeneer
        {GOLD4 220 240 260 280}
        {INCOME4 12 14 16 18} # this income is modified later; see "new turn" event below
        {ANO_ENEMY_LEADER_TRAITS}
        [ai]
            {NO_SCOUTS}
            recruitment_pattern=fighter
            aggression=0.6
            caution=0.0
            grouping=offensive
            passive_leader=yes
            leader_value={ON_DIFFICULTY4 4.0 5.0 6.0 7.0} # (default is 3; keep higher than that)
            [goal]
                name=target_location
                [criteria]
                    x,y=21,21 # Gawen's keep
                [/criteria]
                value={ON_DIFFICULTY4 2 3 4 5}
            [/goal]
#ifdef NIGHTMARE
            [goal]
                [criteria]
                    id=Gawen Hagarthen
                    side=1
                    canrecruit=yes
                [/criteria]
                value=100
            [/goal] #
#endif
        [/ai]
    [/side]
    [side]
        side=4
        id=Uri van Roe
        name=_"Uri van Roe"
        controller=ai
        canrecruit=yes
        team_name=good
        type=Akladian Lord
        facing=nw
        # (all fighters)
        recruit=Akladian Clansman,Akladian Warrior,Akladian Light Infantry,Akladian Raider,Akladian Pikeneer
        {GOLD4 150 180 210 240}
        {INCOME4 7 11 15 19} # this income is modified later; see "new turn" event below
        {ANO_ENEMY_LEADER_TRAITS}
        [ai]
            {NO_SCOUTS}
            recruitment_pattern=fighter
            caution=0.0
            aggression=0.25
            leader_value={ON_DIFFICULTY4 3.2 3.6 4.0 4.4} # (default is 3; keep higher than that)
            [goal]
                # (a goal with no name is basically "target_unit")
                [criteria]
                    id=Gawen Hagarthen
                    side=1
                    canrecruit=yes
                [/criteria]
                # kinda low, but even low values ought to be higher than if we didn't include this goal, right?
                value={ON_DIFFICULTY4 1 2 3 4}
            [/goal]
        [/ai]
        [ai]
            # Turn 15 corresponds to a hardcoded event, and actually there's a hardcoded turn 31 event
            # now, too, so keep both ends of the turn range synced with those events:
            turns=15-30
            [leader_goal]
                x,y=21,21 # Gawen's keep
                id=Uri_attacks_Gawen
                # maybe also mess with auto_remove and/or max_risk?
            [/leader_goal]
            # slightly more than the default of 0.4, but less than the leader_aggression value:
            aggression={ON_DIFFICULTY4 0.42 0.44 0.46 0.48}
            leader_aggression={ON_DIFFICULTY4 0.5 0.6 0.7 0.8}
            retreat_factor=0.0
            retreat_enemy_weight=0.0
            # leader_goal just tells Uri to go there; this tells the rest of his units to go there, too:
            [goal]
                name=target_location
                [criteria]
                    x,y=21,21 # Gawen's keep
                [/criteria]
                # keep this lower than the value for protecting Uri:
                value={ON_DIFFICULTY4 2 3 4 5}
            [/goal]
            # Uri is supposed to survive his assault:
            [goal]
                name=protect_unit
                [criteria]
                    id=Uri van Roe
                    side=4
                    canrecruit=yes
                [/criteria]
                protect_radius=6 # MP of an Akladian Lord
                value={ON_DIFFICULTY4 9 8 7 6}
            [/goal]
        [/ai]
    [/side]
    # Only vary the first two sides:
    {STARTING_VILLAGES 1 {ON_DIFFICULTY4 12 10 8 6}} # (you)
    {STARTING_VILLAGES 2 {ON_DIFFICULTY4 6 7 8 9}} # (Hoyre)
    # Varying these other 2 could spoil things:
    {STARTING_VILLAGES 3 4}
    {STARTING_VILLAGES 4 8}
    {PLACE_IMAGE (scenery/signpost.png) 40 21}
    {PLACE_IMAGE (scenery/signpost.png) 1 4}
    [label]
        x,y=20,3
        text=_"Castle of Barnon"
    [/label]
    [label]
        x,y=22,19
        text=_"City of Barnon"
    [/label]

    [event]
        name=prestart
        [set_variable]
            name=ano_barnon_tr
            value=no
        [/set_variable]
        [set_variable]
            name=ano_lorin_escaped
            value=no
        [/set_variable]
        [set_variable]
            name=ano_howmanyturns
            value={ON_DIFFICULTY4 3 5 7 9}
        [/set_variable]
        [set_variable]
            name=ano_reme_escaped
            value=no
        [/set_variable]
        [set_variable]
            name=ano_barnon_turns
            value=0
        [/set_variable]
        [set_variable]
            name=ano_uri_warned
            value=0
        [/set_variable]
#ifdef EASY
        # Give the player some extra space for recruiting on EASY:
        [terrain]
            x,y=22,21
            terrain=Chr
        [/terrain]
        [terrain]
            x,y=23,20
            terrain=Ke
        [/terrain]
        [terrain]
            x,y=18,17
            terrain=Ke
        [/terrain]
        [terrain]
            x,y=16,19
            terrain=Ke
        [/terrain]
#endif
#ifdef NORMAL
        # ...and also on NORMAL, but not as much:
        [terrain]
            x,y=19,23
            terrain=Ke
        [/terrain]
        [terrain]
            x,y=2,22
            terrain=Khr
        [/terrain]
#endif # NORMAL
        [recall]
            id=Lady Lorin
        [/recall]
        {VARIABLE ano_tr 0}
        # wmllint: recognize Reme Carrenemoe
        {RECALLXY (Reme Carrenemoe) 21 20}
        [unhide_unit]
            [filter]
                id=Reme Carrenemoe
            [/filter]
        [/unhide_unit]

        # Try to add a little bit of extra embellishment to spice up repeated testing:
#ifdef NIGHTMARE
        # Has bones in it:
        {SCATTER_EMBELLISHMENTS G* ^Edp 9}
#else
        {SCATTER_EMBELLISHMENTS G* ^Es 9}
#endif

        {VARIABLE ano_tmp_turn 0}
        {VARIABLE ano_reload false}
        {VARIABLE ano_first_time true}
    [/event]

    [event]
        name=start
        {MSG_Lorin _"This should be easy, my son. Let's just get to the Castle of Barnon to the north and finish that traitor Hoyre off."}
        [scroll_to_unit]
            id=Hoyre O Barnone
            highlight=yes
        [/scroll_to_unit]
        [redraw][/redraw]
        [delay]
            time=500
        [/delay]
#ifdef NIGHTMARE
        {MSG_Reme _"Indeed, let us attack!"}
        {MSG_Gawen _"Okay."}
#else
        {MSG_Reme _"If I may, my lord, I suggest not to attack in haste."}
        {MSG_Gawen _"Why?"}
        {MSG_Reme _"I have deep reservations about how our so-called allies will act."}
        {MSG_Lorin _"You think that they would dare not to attack?"}
        {MSG_Reme _"I am sure that they will dare... it's just I am not sure whom they will attack."}
        {MSG_Lorin _"Nonsense. They know that the lives of their sons are in our hands."}
#endif
        [set_variable]
            name=ano_units_last_index
            value=0
        [/set_variable]
        [store_gold]
            side=1
            variable=gold
        [/store_gold]
        [if]
            [variable]
                name=gold
                less_than=150
            [/variable]
            [then]
                {MSG_Reme _"I am not sure whether we have enough gold for this endeavor. I wish we had accumulated more in previous battles."}
            [/then]
        [/if]
        [objectives]
            side=1
            [objective]
                description=_"Kill all enemy leaders"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Gawen Hagarthen"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Lady Lorin"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Reme Carrenemoe"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT} # (this gets removed once turns become unlimited, so it's ok to have at the start)
        [/objectives]
    [/event]

    # next macro is from macros/debug.cfg; contains an "ifdef DEBUG_MODE" preprocessor conditional:
    {SET_SCENARIO_STATUS_TO (
        [option]
            # po: debug option; completes sentence starting with "Set scenario status to...":
            message=_"being betrayed."
            [command]
                [modify_side]
                    side=4
                    team_name=bad
                [/modify_side]
                {REPLACE_SCENARIO_MUSIC theme_of_a_new_order.ogg}
                [modify_side]
                    side=3
                    team_name=bad
                [/modify_side]
                {APPEND_MUSIC battle/onethousandsuns.ogg}
                {APPEND_MUSIC battle/battlecry.ogg}
                {APPEND_MUSIC battle/gameplay06.ogg}
                {APPEND_MUSIC siege_of_laurelmor.ogg}
                {APPEND_MUSIC battle-epic.ogg}
                # po: this should only show in debug mode, so we can break the fourth wall there:
                {ANO4_TRAITORS _"Blah blah blah; if you are seeing this, you should already know what the deal is."}
            [/command]
            [show_if]
                [variable]
                    name=ano_barnon_tr
                    equals=no
                [/variable]
            [/show_if]
        [/option]
        [option]
            # po: debug option; completes sentence starting with "Set scenario status to...":
            message=_"Uri personally attacking Barnon."
            [command]
                [fire_event]
                    name=turn 15
                    id=Uri_gets_impatient
                [/fire_event]
            [/command]
            [show_if]
                [variable]
                    name=ano_barnon_tr
                    equals=yes
                [/variable]
            [/show_if]
        [/option]
        [option]
            # po: debug option; completes sentence starting with "Set scenario status to...":
            message=_"moving on to Unexpected Guests."
            [command]
                [move_unit]
                    id=Lady Lorin
                    to_x,to_y=1,4
                    fire_event=yes
                [/move_unit]
                [redraw][/redraw]
                [move_unit]
                    id=Reme Carrenemoe
                    to_x,to_y=1,4
                    fire_event=yes
                [/move_unit]
                {END_OF_BARNON_CLEANUP}
                [endlevel]
                    result=victory
                    bonus=no
                    carryover_percentage=100
                    next_scenario=05_Unexpected_Guests
                    linger_mode=no
                [/endlevel]
            [/command]
            [show_if]
                [variable]
                    name=ano_barnon_tr
                    equals=yes
                [/variable]
            [/show_if]
        [/option]
        [option]
            # po: debug option; completes sentence starting with "Set scenario status to...":
            message=_"moving on to The Swamp Things."
            [command]
                [move_unit]
                    id=Lady Lorin
                    to_x,to_y=40,21
                    fire_event=yes
                [/move_unit]
                [redraw][/redraw]
                [move_unit]
                    id=Reme Carrenemoe
                    to_x,to_y=40,21
                    fire_event=yes
                [/move_unit]
                {END_OF_BARNON_CLEANUP}
                [endlevel]
                    result=victory
                    bonus=no
                    carryover_percentage=100
                    next_scenario=05_The_Swamp_Things
                    linger_mode=no
                [/endlevel]
            [/command]
            [show_if]
                [variable]
                    name=ano_barnon_tr
                    equals=yes
                [/variable]
            [/show_if]
        [/option]
    )}

    # This macro (EVACUATE) is defined in ano-01_06macros.cfg and contains the code for units escaping from this battle:
    {EVACUATE 40 21}
    {EVACUATE 1 4}

    [event]
        name=moveto
        [filter]
            x=1-40
            y=25-35
            side=4
        [/filter]
        [if]
            [variable]
                name=ano_barnon_tr
                equals=no
            [/variable]
            [then]
                {MSG_Hoyre _"It is a dark day indeed, to see Akladian lords siding with an underling bastard child. What will your ancestors say about this, Uri?"}
                {MSG_Uri _"Hoyre, you have always been my friend. I would never fight against you. Rather, I join with you to kill that mixling!"}
                [modify_side]
                    side=4
                    team_name=bad
                [/modify_side]

                {REPLACE_SCENARIO_MUSIC theme_of_a_new_order.ogg}
                {MSG_Cryne _"I've never intended to fight against you, Hoyre. Let our swords instead cut that underling's head off! And slay that witch, his step-mother, as well!"}
                [modify_side]
                    side=3
                    team_name=bad
                [/modify_side]
                {APPEND_MUSIC battle/onethousandsuns.ogg}
                {APPEND_MUSIC battle/battlecry.ogg}
                {APPEND_MUSIC battle/gameplay06.ogg}
                {APPEND_MUSIC siege_of_laurelmor.ogg}
                {APPEND_MUSIC battle-epic.ogg}
                # This macro (ANO4_TRAITORS) is defined in ano-01_06macros.cfg and contains most of the dialogue that occurs here:
                {ANO4_TRAITORS _"Reach either the eastern or western signpost with both Lorin AND Reme. After that, hold on at least $ano_howmanyturns turns before the honorable death of Gawen Hagarthen."}
            [/then]
        [/if]
    [/event]

    [event]
        name=moveto
        [filter]
            x=1-40
            y=25-35
            side=3
        [/filter]
        [if]
            [variable]
                name=ano_barnon_tr
                equals=no
            [/variable]
            [then]
                {MSG_Hoyre _"We spent so many days drinking and fighting together. Now you come with an army against me? What about our plans, Bor?"}
                {MSG_Cryne _"Our plans haven't changed, Hoyre. You were and are my friend. I only came here with the underling so we could trap him. I am with you!"}
                [modify_side]
                    side=3
                    team_name=bad
                [/modify_side]
                {MSG_Uri _"Noble Lords, count on me too! Death to that scraggy mixling, that witch and all the traitors who support them against our own kin! God with us! Kill them all, let us eat their hearts!"}
                [modify_side]
                    side=4
                    team_name=bad
                [/modify_side]
                # If this music replacement doesn't work, that means you probably forgot to install the Akladian Music add-on:
                {REPLACE_SCENARIO_MUSIC theme_of_a_new_order.ogg}
                # This macro (ANO4_TRAITORS) is defined in ano-01_06macros.cfg and contains most of the dialogue that occurs here:
                {ANO4_TRAITORS _"Reach either the eastern or western signpost with both Lorin AND Reme. After that, hold on at least $ano_howmanyturns turns before the honorable death of Gawen Hagarthen."}
                {APPEND_MUSIC battle/onethousandsuns.ogg}
                {APPEND_MUSIC battle/battlecry.ogg}
                {APPEND_MUSIC battle/gameplay06.ogg}
                {APPEND_MUSIC siege_of_laurelmor.ogg}
                {APPEND_MUSIC battle-epic.ogg}
                {APPEND_MUSIC battle.ogg}
                {APPEND_MUSIC battle/ambuscade.ogg}
                {APPEND_MUSIC battle/fragments_of_time_cut.ogg}
            [/then]
        [/if]
    [/event]
    {REME_DEATH}
    {LORIN_DEATH}

    [event]
        name=new turn
        first_time_only=no
        [if]
            [variable]
                name=ano_lorin_escaped
                equals=yes
            [/variable]
            [variable]
                name=ano_reme_escaped
                equals=yes
            [/variable]
            [then]
                {CLEAR_VARIABLE ano_tr}
                {VARIABLE_OP ano_barnon_turns add 1}
                [if]
                    [variable]
                        name=ano_barnon_turns
                        greater_than_equal_to=$ano_howmanyturns
                    [/variable]
                    [then]
                        [set_variable]
                            name=ano_tmp
                            value=$ano_howmanyturns
                        [/set_variable]
                        {VARIABLE_OP ano_tmp multiply (-1)}
                        {VARIABLE_OP ano_tmp add $ano_barnon_turns}
                        [if]
                            [variable]
                                name=ano_tmp
                                equals=0
                            [/variable]
                            [then]
                                [print]
                                    text=_"With this turn, you have met the survival requirement!"
                                    size=18
                                    red,green,blue=255,255,255
                                [/print]
                            [/then]
                            [else]
                                [print]
                                    #po: FIXME: plurals; see: https://github.com/wesnoth/wesnoth/issues/1135
                                    text=_"Bonus for resisting $ano_tmp| turns above requirement"
                                    size=18
                                    red,green,blue=255,255,255
                                [/print]
                            [/else]
                        [/if]
                    [/then]
                    [else]
                        [print]
                            # TODO: include how many are left until you meet the requirement:
                            text=_"Resisted $ano_barnon_turns| turns."
                            size=18
                            red,green,blue=255,255,255
                        [/print]
                    [/else]
                [/if]
            [/then]
            [else]
                # This is the case where no one has escaped yet; if player is still goofing off leaving Lorin & Reme on the battlefield,
                # then they deserve this:
                {VARIABLE_OP ano_tr add 1}
                {IF ano_tr equals 5}
#ifdef NIGHTMARE
                [redraw][/redraw]
#else
                {IF anon_barnon_tr equals yes}
                {IF_HAVE_UNIT (Reme Carrenemoe)}
                {MSG_Reme _"Gawen, you really ought to be getting us out of here..."}
                {ELSE}
                {IF_HAVE_UNIT (Lady Lorin)}
                # Lorin probably wouldn't remind Gawen to evacuate her, since she wants to stay, so have Gawen speak in this case instead:
                {MSG_Gawen _"I thought I told my men to evacuate my step-mother, yet she remains on the battlefield... how stubborn..."}
                {ELSE}
                {IF_HAVE_UNIT (Hoyre O Barnone)}
                # This probably shouldn't ever be reached, but just in case:
                {MSG_Hoyre _"Wait a second, something odd seems to be happening here..."}
                {ELSE}
                # REALLY shouldn't ever be reached:
                {MSG_narrator _"At this moment, Gawen remembered what he was trying to do."}
                {TWO_END_IFs}
                {END_IF}
                {ELSE}
                [redraw][/redraw]
                {END_IF}
#endif
                {ELSE}
                {IF ano_tr equals 6} # To make it more certain that Gawen cannot win
                [gold]
                    side=3 # Bor Cryne
                    amount={ON_DIFFICULTY4 50 60 70 80}
                [/gold]
                [gold]
                    side=4 # Uri Van Roe
                    amount={ON_DIFFICULTY4 10 20 30 40}
                [/gold]
                {ELSE}
                [redraw][/redraw]
                {TWO_END_IFs}
            [/else]
        [/if]
        # Keep the ON_DIFFICULTY4 parts of these synced with their initial income declarations above:
        [modify_side]
            side=2 # Hoyre
            income="$({ON_DIFFICULTY4 7 9 11 14} + ($turn_number / 2))"
        [/modify_side]
        [modify_side]
            side=3 # Bor Cryne
            income="$({ON_DIFFICULTY4 12 14 16 18} + ($turn_number / 2))"
        [/modify_side]
        [modify_side]
            side=4 # Uri Van Roe
            income="$({ON_DIFFICULTY4 7 11 15 19} + ($turn_number / 2))"
        [/modify_side]
        # (while in S02 I took the log of the turn number, and used min(), this one is supposed to be harder, so don't do either of those here)
#ifdef NIGHTMARE
        # idea: spawn enemy units: 2,40 for Bor Cryne, and 38,40 for Uri van Roe
        # have the type of unit be based on the turn number
        [if]
            [variable]
                name=ano_barnon_tr
                equals=yes # i.e. you've already been betrayed
            [/variable]
            [then]
                {IF ano_barnon_turns equals 0}
                # Lorin and Reme haven't escaped yet
                {IF ano_tr greater_than_equal_to 7}
                {IF_TURN_EVEN}
                {IF_NOT_HAVE_CREATE_LOYAL 3 (Akladian Clansman) 2 40}
                {END_IF_WITHOUT_ELSE}
                {IF_TURN_ODD}
                {IF_NOT_HAVE_CREATE_LOYAL 4 (Akladian Clansman) 38 40}
                {END_IF_WITHOUT_ELSE}
                {END_IF_WITHOUT_ELSE} # ano_tr
                {ELSE}
                {IF ano_barnon_turns less_than $ano_howmanyturns|}
                # Lorin and Reme have escaped, but Gawen still needs to resist
                {IF_TURN_EVEN}
                {IF_NOT_HAVE_CREATE_LOYAL 3 (Akladian Warrior) 2 40}
                {END_IF_WITHOUT_ELSE}
                {IF_TURN_ODD}
                {IF_NOT_HAVE_CREATE_LOYAL 4 (Akladian Warrior) 38 40}
                {END_IF_WITHOUT_ELSE}
                {ELSE}
                {IF ano_tmp greater_than_equal_to 1}
                # Gawen is above the requirement and into bonus turns
                {IF_TURN_EVEN}
                {IF_NOT_HAVE_CREATE_LOYAL 3 (Akladian Light Infantry) 2 40}
                {END_IF_WITHOUT_ELSE}
                {IF_TURN_ODD}
                {IF_NOT_HAVE_CREATE_LOYAL 4 (Akladian Light Infantry) 38 40}
                {END_IF_WITHOUT_ELSE}
                {ELSE}
                {IF ano_uri_warned greater_than_equal_to 3}
                # probably not reached
                {IF_TURN_EVEN}
                {IF_NOT_HAVE_CREATE_LOYAL 3 (Akladian Pikeneer) 2 40}
                {END_IF_WITHOUT_ELSE}
                {IF_TURN_ODD}
                {IF_NOT_HAVE_CREATE_LOYAL 4 (Akladian Pikeneer) 38 40}
                {END_IF_WITHOUT_ELSE}
                {ELSE}
                [redraw][/redraw]
                {FOUR_END_IFs}
            [/then]
        [/if]
#endif
    [/event]

    [event]
        name=turn 15
        id=Uri_gets_impatient
#ifdef BE_PUNISHING
        # To make it more certain that Gawen cannot win
        [gold]
            side=3 # Bor Cryne
            amount={ON_DIFFICULTY4 40 50 60 70}
        [/gold]
        [gold]
            side=4 # Uri van Roe
            amount={ON_DIFFICULTY4 35 45 55 65}
        [/gold]
#else
        [gold]
            side=3 # Bor Cryne
            amount={ON_DIFFICULTY4 10 20 30 40}
        [/gold]
        [gold]
            side=4 # Uri van Roe
            amount={ON_DIFFICULTY4 5 10 15 20}
        [/gold]
#endif
        {MSG_Uri _"This is taking too long. Men, gather me an escort, for I shall be taking this battle to the mixling myself!"}
        {IF_NOT_HAVE_CREATE_LOYAL 4 {ON_DIFFICULTY4 (Akladian Clansman) (Akladian Warrior) (Akladian Shieldguard) (Akladian Protector)} 39 36}
        {IF_NOT_HAVE_CREATE_LOYAL 4 {ON_DIFFICULTY4 (Akladian Clansman) (Akladian Warrior) (Akladian Shieldguard) (Akladian Protector)} 38 36}
        {IF_NOT_HAVE_CREATE_LOYAL 4 {ON_DIFFICULTY4 (Akladian Clansman) (Akladian Warrior) (Akladian Shieldguard) (Akladian Protector)} 40 36}
        {IF_NOT_HAVE_CREATE_LOYAL 4 {ON_DIFFICULTY4 (Akladian Clansman) (Akladian Warrior) (Akladian Shieldguard) (Akladian Protector)} 38 37}
        {IF_NOT_HAVE_CREATE_LOYAL 4 {ON_DIFFICULTY4 (Akladian Clansman) (Akladian Warrior) (Akladian Shieldguard) (Akladian Protector)} 40 37}
        {IF_NOT_HAVE_CREATE_LOYAL 4 {ON_DIFFICULTY4 (Akladian Clansman) (Akladian Warrior) (Akladian Shieldguard) (Akladian Protector)} 39 38}
        [redraw][/redraw]
        [if]
            # Remember, we are in a "turn 15" event, so this check should only happen once, on turn 15:
            [not]
                [have_unit]
                    side=1
                    x,y=21,21 # Gawen's keep
                [/have_unit]
            [/not]
            [then]
                # He already has a leader_goal aiming here, but if the path is already clear, then give him a bit of extra prompting:
                [modify_unit]
                    [filter]
                        id=Uri van Roe
                    [/filter]
                    goto_x,goto_y=21,21 # The empty keep that Gawen presumably abandoned
                [/modify_unit]
                {MSG_Uri _"To Barnon!"}
            [/then]
            [else]
                {MSG_Uri _"You can't stay holed up there forever, Gawen!"}
            [/else]
        [/if]
        # if both the leader_goal and the goto modification fail,
        # use this MAI as one more way to try to make this work:
        [micro_ai]
            side=4
            ai_type=messenger_escort
            ca_id=escort_Uri_to_Barnon
            action=add

            [filter]
                id=Uri van Roe
            [/filter]
            waypoint_x=36,34,33,31,26,25,23,21
            waypoint_y=36,33,31,29,27,25,23,21
            # slightly higher than the Goto CA of 200,000 (since Uri may have that set),
            # but lower than the default MAI score of 300,000:
            ca_score=210000 # (no comma in the actual number though)
            # (may also want to try messing with the enemy_death_chance and messenger_death_chance keys)
        [/micro_ai]
        # Since Uri's side has a leader_goal (targeting 21,21) starting on turn 15, this means that the player can attack him
        # without first triggering the moveto event guarding him (see farther below). Add these events as backups:
        [event]
            name=attack
            first_time_only=no
            [filter_second]
                id=Uri van Roe
            [/filter_second]
            [if]
                [variable]
                    name=ano_uri_warned
                    less_than=1
                [/variable]
                [then]
                    {MSG_Uri _"The mixling resists my attack! Men, join me!"}
                    # for the other one:
                    {VARIABLE_OP ano_uri_warned add 1}
                    [gold]
                        side=4
                        amount={ON_DIFFICULTY4 100 140 180 220}
                    [/gold]
                    [unit]
                        type=Akladian Darknite
                        side=4
                        x=38
                        y=35
                        [modifications]
                            {TRAIT_LOYAL}
                            {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                            {TRAIT_STRONG}
#endif
                        [/modifications]
                    [/unit]
                    [unit]
                        type=Akladian Darknite
                        side=4
                        x=36
                        y=35
                        [modifications]
                            {TRAIT_LOYAL}
                            {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                            {TRAIT_STRONG}
#endif
                        [/modifications]
                    [/unit]
                    [unit]
                        type=Akladian Darknite
                        side=4
                        x=37
                        y=34
                        [modifications]
                            {TRAIT_LOYAL}
                            {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                            {TRAIT_STRONG}
#endif
                        [/modifications]
                    [/unit]
                    [scroll_to]
                        x,y=37,34
                    [/scroll_to]
                    [redraw]
                    [/redraw]
                    [delay]
                        time=500
                    [/delay]
                    {IF_NOT_HAVE_CREATE_LOYAL 4 {ON_DIFFICULTY4 (Akladian Wiseman) (Akladian Holyman) (Akladian Wonderman) (Akladian Wonderman)} 39 37}
                    [store_locations]
                        [filter]
                            id=Uri van Roe
                        [/filter]
                        variable=Uri_loc1
                    [/store_locations]
                    [move_unit]
                        side=4
                        type_adv_tree=Akladian Wiseman
                        to_x=$Uri_loc1.x
                        to_y=$Uri_loc1.y
                    [/move_unit]
                    [move_unit]
                        side=4
                        type=Akladian Darknite
                        to_x=$Uri_loc1.x
                        to_y=$Uri_loc1.y
                    [/move_unit]
                    {CLEAR_VARIABLE Uri_loc1}
                    {MSG_Uri _"You'd better watch out, Gawen, because I've got more where that came from!"}
                [/then]
                [elseif]
                    # Only do this once more after the initial warning:
                    [variable]
                        name=ano_uri_warned
                        equals=1
                    [/variable]
                    [then]
                        {MSG_Uri _"I told you I had more guards!"}
                        {VARIABLE_OP ano_uri_warned add 1}
                        {REPEAT {ON_DIFFICULTY4 2 3 4 5} (
                            [unit]
                                type=Akladian Protector
                                side=4
                                placement=leader
                                passable=yes
                                [modifications]
                                    {TRAIT_LOYAL}
                                    {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                                    {TRAIT_STRONG}
#endif
                                [/modifications]
                            [/unit]
                        )}
                    [/then]
                [/elseif]
            [/if]
        [/event]
        # also do it the other way around:
        [event]
            name=attack
            first_time_only=no
            [filter]
                id=Uri van Roe
            [/filter]
            [filter_second]
                side=1
            [/filter_second]
            [if]
                [variable]
                    name=ano_uri_warned
                    less_than=1
                [/variable]
                [then]
                    {MSG_Uri _"Men, join me in my attack!"}
                    # for the other one:
                    {VARIABLE_OP ano_uri_warned add 1}
                    [gold]
                        side=4
                        amount={ON_DIFFICULTY4 120 140 160 180}
                    [/gold]
                    [unit]
                        type=Akladian Darknite
                        side=4
                        x=37
                        y=34
                        [modifications]
                            {TRAIT_LOYAL}
                            {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                            {TRAIT_STRONG}
#endif
                        [/modifications]
                    [/unit]
                    [unit]
                        type=Akladian Darknite
                        side=4
                        x=35
                        y=34
                        [modifications]
                            {TRAIT_LOYAL}
                            {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                            {TRAIT_STRONG}
#endif
                        [/modifications]
                    [/unit]
                    [unit]
                        type=Akladian Darknite
                        side=4
                        x=36
                        y=33
                        [modifications]
                            {TRAIT_LOYAL}
                            {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                            {TRAIT_STRONG}
#endif
                        [/modifications]
                    [/unit]
                    [scroll_to]
                        x,y=36,33
                    [/scroll_to]
                    [redraw]
                    [/redraw]
                    [delay]
                        time=500
                    [/delay]
                    {IF_NOT_HAVE_CREATE_LOYAL 4 {ON_DIFFICULTY4 (Akladian Wiseman) (Akladian Holyman) (Akladian Wonderman) (Akladian Wonderman)} 39 37}
                    [store_locations]
                        [filter]
                            id=Uri van Roe
                        [/filter]
                        variable=Uri_loc2
                    [/store_locations]
                    [move_unit]
                        side=4
                        type_adv_tree=Akladian Wiseman
                        to_x=$Uri_loc2.x
                        to_y=$Uri_loc2.y
                    [/move_unit]
                    [move_unit]
                        side=4
                        type=Akladian Darknite
                        to_x=$Uri_loc2.x
                        to_y=$Uri_loc2.y
                    [/move_unit]
                    {CLEAR_VARIABLE Uri_loc2}
                    {MSG_Uri _"You'd better watch out, Gawen, because I've got more where that came from!"}
                [/then]
                [elseif]
                    # Only do this once more after the initial warning:
                    [variable]
                        name=ano_uri_warned
                        equals=1
                    [/variable]
                    [then]
                        {MSG_Uri _"I told you I had more guards!"}
                        {VARIABLE_OP ano_uri_warned add 1}
                        {REPEAT {ON_DIFFICULTY4 2 3 4 5} (
                            [unit]
                                type=Akladian Protector
                                side=4
                                placement=leader
                                passable=yes
                                [modifications]
                                    {TRAIT_LOYAL}
                                    {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                                    {TRAIT_STRONG}
#endif
                                [/modifications]
                            [/unit]
                        )}
                    [/then]
                [/elseif]
            [/if]
        [/event]
        [event]
            name=moveto
            [filter]
                id=Uri van Roe
                side=4
                canrecruit=yes
                x,y=21,21 # Gawen's keep (Uri's goal)
            [/filter]
            {MSG_Uri _"Your city has fallen, Gawen! Surrender now, and I promise you that we won't torture you <small>(as much)</small> before killing you!"}
            {MSG_Gawen _"Never!"}
            # If we don't delete the MAI once Uri gets to Barnon, he just hangs around there:
            [micro_ai]
                side=4
                ai_type=messenger_escort
                ca_id=escort_Uri_to_Barnon
                action=delete
            [/micro_ai]
        [/event]
        [event]
            # turn after his leader_goal wears off:
            name=turn 31
            {MSG_Uri _"I tire of this. Men, the task now returns to you to kill that scraggy mixling!"}
            [if]
                [have_unit]
                    id=Uri van Roe
                    side=4
                    canrecruit=yes
                    x,y=21,21 # i.e., he made it to his goal
                [/have_unit]
                [then]
                    [modify_unit]
                        [filter]
                            id=Uri van Roe
                        [/filter]
                        moves=0
                    [/modify_unit]
                    [modify_side]
                        side=4
                        [ai]
                            leader_aggression="-5.5"
                            passive_leader=yes
                            passive_leader_shares_keep=yes
                            # Meanwhile, for his other units:
                            aggression=1.0
                            leader_value={ON_DIFFICULTY4 5.3 5.9 6.5 7.1} # (higher than its previous value of {3.2 3.6 4.0 4.4})
                            [goal]
                                # (a goal with no name is basically "target_unit")
                                [criteria]
                                    id=Gawen Hagarthen
                                    side=1
                                    canrecruit=yes
                                [/criteria]
                                # higher than any value that Uri has had for an AI goal yet:
                                value={ON_DIFFICULTY4 11 22 33 44}
                            [/goal]
                        [/ai]
                    [/modify_side]
                [/then]
                [else]
                    [redraw][/redraw]
                    # TODO (...slow?)
                [/else]
            [/if]
        [/event]
    [/event]

    [event]
        # {(3 times) (4 times) (6 times) (9 times)} (nonlinear due to each difficulty needing to have a final turn later than the prev. 1)
        # Use ifdefs instead of the ON_DIFFICULTY4 macro here to keep line length down:
#ifdef EASY
        name=turn 20,turn 25,turn 30
#endif
#ifdef NORMAL
        name=turn 20,turn 24,turn 28,turn 32
#endif
#ifdef HARD
        name=turn 20,turn 23,turn 26,turn 29,turn 32,turn 35
#endif
#ifdef NIGHTMARE
        name=turn 20,turn 22,turn 24,turn 26,turn 28,turn 30,turn 32,turn 34,turn 36
#endif
        id=more_enemy_gold
        first_time_only=no
#ifdef BE_PUNISHING
        # To make it more certain that Gawen cannot win
        [gold]
            side=3 # Bor Cryne
            amount={ON_DIFFICULTY4 48 54 60 66}
        [/gold]
        [gold]
            side=4 # Uri van Roe
            amount={ON_DIFFICULTY4 40 41 42 44} # (violating pattern because I like 44 better as a number than 43)
        [/gold]
#else
        [gold]
            side=3 # Bor Cryne
            amount={ON_DIFFICULTY4 20 28 36 44}
        [/gold]
        [gold]
            side=4 # Uri van Roe
            amount={ON_DIFFICULTY4 10 12 14 16}
        [/gold]
#endif
    [/event]

    # Gawen dies:
    [event]
        name=last breath
        [filter]
            side=1
            canrecruit=yes
        [/filter]
        [if]
            [variable]
                name=ano_barnon_turns
                greater_than_equal_to=$ano_howmanyturns
            [/variable]
            [then]
                {MSG_Gawen _"I hope both Reme and Lorin have made it... Aaargh!"}
                [store_unit]
                    [filter]
                        side=1
                        canrecruit=yes
                    [/filter]
                    variable=ano_gawen
                [/store_unit]
                [message]
                    speaker=second_unit
                    message=_"I think we killed him, my lord!"
                [/message]
                {MSG_Cryne _"You 'think'!? Where is his body? Search for it, fools, I want to be sure!"}
                [store_unit]
                    [filter]
                        [not]
                            canrecruit=yes
                        [/not]
                        side=1
                    [/filter]
                    variable=ano_prisoned
                    kill=yes
                [/store_unit]
                [modify_side]
                    side=1
                    current_player=_"Lady Lorin"
                    save_id="Lady Lorin"
                [/modify_side]
                [if]
                    {CONDITION ano_lorin_via equals 1}
                    [then]
                        {CLEAR_VARIABLE ano_lorin_via}
                        {CLEAR_VARIABLE ano_reme_via}
                        [endlevel]
                            result=victory
                            bonus=no
                            carryover_percentage=100
                            next_scenario=05_Unexpected_Guests
                            linger_mode=no
                        [/endlevel]
                    [/then]
                    [else]
                        [endlevel]
                            result=victory
                            bonus=no
                            carryover_percentage=100
                            next_scenario=05_The_Swamp_Things
                            linger_mode=no
                        [/endlevel]
                    [/else]
                [/if]
            [/then]
            [else]
                [endlevel]
                    result=defeat
                [/endlevel]
            [/else]
        [/if]
    [/event]

    [event]
        name=enemies defeated
        first_time_only=no # because this could fire when Hoyre is the only enemy, in which case we need to trigger the betrayal, which means it could happen again
        [if]
            [variable]
                name=ano_barnon_tr
                equals=no
            [/variable]
            [and]
                [have_unit]
                    id=Bor Cryne
                    [filter_side]
                        [allied_with]
                            side=1
                        [/allied_with]
                    [/filter_side]
                [/have_unit]
            [/and]
            [and]
                [have_unit]
                    id=Uri van Roe
                    [filter_side]
                        [allied_with]
                            side=1
                        [/allied_with]
                    [/filter_side]
                [/have_unit]
            [/and]
            [then]
                {MSG_Uri _"...well, now that Gawen thinks he's won, there's no need to keep up this farce, is there, Bor?"}
                [modify_side]
                    side=4
                    team_name=bad
                [/modify_side]

                {REPLACE_SCENARIO_MUSIC theme_of_a_new_order.ogg}
                {MSG_Cryne _"Indeed, Uri, there isn't! Let our swords instead cut that underling's head off! And slay that witch, his step-mother, as well!"}
                [modify_side]
                    side=3
                    team_name=bad
                [/modify_side]
                {APPEND_MUSIC battle/onethousandsuns.ogg}
                {APPEND_MUSIC battle/battlecry.ogg}
                {APPEND_MUSIC battle/gameplay06.ogg}
                {APPEND_MUSIC siege_of_laurelmor.ogg}
                {APPEND_MUSIC battle-epic.ogg}
                # This macro (ANO4_TRAITORS) is defined in ano-01_06macros.cfg and contains most of the dialogue that occurs here:
                {ANO4_TRAITORS _"Reach either the eastern or western signpost with both Lorin AND Reme. After that, hold on at least $ano_howmanyturns turns before the honorable death of Gawen Hagarthen."}
            [/then]
            [else]
#ifdef DEBUG_MODE
                {IF_DEBUG_MODE_IS_ACTUALLY_ON}
                {MSG_narrator _"Using debug mode to kill all the enemies is cheating!"}
                {ELSE}
                {MSG_narrator _"DEBUG_MODE is defined; that means you probably cheated to kill all the enemies!"}
                {END_IF}
#else
                {MSG_narrator _"Despite the incredible odds stacked against him, Gawen somehow managed to defeat all of his enemies at Barnon."}
                {MSG_narrator _"However, this meant that he never managed to unite the warring factions of Wesnoth..."}
#endif
                {MSG_narrator _"This is an early end to the campaign. If you would like to see the rest of it, please replay this scenario and let Gawen be defeated as he is supposed to be."}
                {MSG_narrator _"For now, though, we shall skip ahead to the campaign wrap-up."}
                {VARIABLE ano_early_campaign_ending yes}
                {CLEAR_VARIABLE ano_gawen_units}
                {CLEAR_VARIABLE ano_level_three}
                [store_unit]
                    [filter]
                        side=1
                        # Gawen should only be able to have Akladians at this point in the campaign, so no need to check for as much as we do in Orannon:
                        type=Akladian Darknite,Akladian Fastfoot,Akladian Pikeneer,Akladian Protector,Akladian Wonderman
                    [/filter]
                    variable=ano_level_three
                    kill=no
                [/store_unit]
                [endlevel]
                    result=victory
                    bonus=no
                    next_scenario=30_Final
                    carryover_report=no
                    carryover_percentage=100
                    linger_mode=no
                    save=no
                [/endlevel]
            [/else]
        [/if]
    [/event]

    # Post-victory cleanup:
    [event]
        name=victory
        {CLEAR_VARIABLE ano_tmp_turn} #used in events detecting reload
        {CLEAR_VARIABLE ano_reload} #used in events detecting reload
        {CLEAR_VARIABLE ano_first_time} #used in events detecting reload
        {VARIABLE_OP ano_howmanyturns multiply -1}
        {VARIABLE_OP ano_barnon_turns add $ano_howmanyturns}
        {VARIABLE bonus_amt {ON_DIFFICULTY4 60 50 40 30}}
        {VARIABLE_OP ano_barnon_turns multiply $bonus_amt}
        {VARIABLE_OP ano_howmanyturns multiply -1}

        {IF ano_barnon_turns less_than 0}
        {VARIABLE ano_barnon_turns 0}
        {END_IF_WITHOUT_ELSE}

        {IF ano_early_campaign_ending equals yes}
        {MSG_narrator _"If this campaign were continuing normally from here, Lorin would receive a bonus of $bonus_amt|g per each turn above the minimum of $ano_howmanyturns extra turns: $ano_barnon_turns"}
        {ELSE}
        #po: TODO: consider rewording to make it clearer what the last two variables are:
        {MSG_narrator _"Gawen's sacrifice successfully bought Lorin more time to escape! Thus, she gets a bonus for his resistance: Lorin receives $bonus_amt|g per each turn above $ano_howmanyturns: $ano_barnon_turns"}
        {END_IF}
        {CLEAR_VARIABLE ano_reme_escaped}
        {CLEAR_VARIABLE ano_lorin_escaped}
        {CLEAR_VARIABLE ano_howmanyturns}
        {CLEAR_VARIABLE ano_howmanyturnstext}

        [gold]
            side=1
            amount=$ano_barnon_turns
        [/gold]
        {CLEAR_VARIABLE ano_barnon_tr}
        {CLEAR_VARIABLE ano_barnon_turns}
        {CLEAR_VARIABLE ano_reme_via}
        {CLEAR_VARIABLE ano_lorin_via}
        {CLEAR_RECALL}
        [store_gold]
            variable=gold
        [/store_gold]
        {VARIABLE ano_lorin_gold $gold}
        {VARIABLE_OP ano_lorin_gold multiply {ON_DIFFICULTY4 0.9 0.8 0.7 0.6}}
#ifdef DEBUG_MODE
        {IF_DEBUG_MODE_IS_ACTUALLY_ON}
        {DEBUGMSG1 "Lorin now has $ano_lorin_gold gold."}
        {END_IF_WITHOUT_ELSE}
#endif
        {CLEAR_VARIABLE bonus_amt}
    [/event]

    # Turns run out:
    [event]
        name=time over
        {IF ano_reme_escaped equals no}
        {ANO4_TIMEOVER_REINFORCEMENTS} # defined in ano-01_06macros.cfg
        {MSG_Gawen _"Oh no! Fresh enemy reinforcements have arrived, Reme, and you have no chance to escape! I can't hold them!"}
        [endlevel]
            result=defeat
        [/endlevel]
        {ELSE_IF ano_lorin_escaped equals no}
        {ANO4_TIMEOVER_REINFORCEMENTS} # defined in ano-01_06macros.cfg
        {MSG_Gawen _"Oh no! Fresh enemy reinforcements have arrived, Lorin, and you have no chance to escape! I can't hold them!"}
        [endlevel]
            result=defeat
        [/endlevel]
        {ELSE}
        #po: This in fact should be EXTREMELY hard. In fact, it ought to be impossible, as the turn limit becomes unlimited after Reme and Lorin escape:
        {MSG_narrator _"After the end of the day king's forces were defeated; however, no one could find the body of Gawen Hagarthen."}
        {VARIABLE ano_barnon_timeover yes}
        [store_unit]
            [filter]
                side=1
                canrecruit=yes
            [/filter]
            variable=ano_gawen
            kill=yes
        [/store_unit]
        [store_unit]
            [filter]
                [not]
                    canrecruit=yes
                [/not]
                side=1
            [/filter]
            variable=ano_prisoned
            kill=yes
        [/store_unit]
        {CLEAR_RECALL}
        [if]
            {CONDITION ano_lorin_via equals 1}
            [then]
                {CLEAR_VARIABLE ano_lorin_via}
                {CLEAR_VARIABLE ano_reme_via}
                [endlevel]
                    result=victory
                    bonus=no
                    carryover_percentage=100
                    next_scenario=05_Unexpected_Guests
                    linger_mode=no
                [/endlevel]
            [/then]
            [else]
                [endlevel]
                    result=victory
                    bonus=no
                    carryover_percentage=100
                    next_scenario=05_The_Swamp_Things
                    linger_mode=no
                [/endlevel]
            [/else]
        [/if]
        {TWO_END_IFs}
    [/event]

    # Note: szopen hated this part of the code. When he played, he felt cheated when he tried
    # to kill Hoyre for a few turns. Therefore, he threw it out.
    # ...I'm going to bring it back for NIGHTMARE difficulty though:
#ifdef NIGHTMARE
    # For storyline purposes, make it impossible to kill Hoyre O Barnone, Bor Cryne, and Uri van Roe. - Shamelessly cribbed from Descent Into Darkness
    {FORCE_CHANCE_TO_HIT side=1 id="Hoyre O Barnone" 0 ()}
    {FORCE_CHANCE_TO_HIT side=1 id="Bor Cryne" 0 ()}
    {FORCE_CHANCE_TO_HIT side=1 id="Uri van Roe" 0 ()}
#endif
    # Instead, we will script Hoyre escaping (farther below, that is)
    # (this isn't what actually makes him run away, it's just a backup)
    [event]
        # an "attacker hits" event fits the ensuing dialogue better than the "attack" event this was previously, IMO:
        name=attacker hits
        [filter]
            side=1
        [/filter]
        [filter_second]
            id="Hoyre O Barnone"
        [/filter_second]
        {MSG_Hoyre _"Argh! I am wounded!"}
        {MSG_Cryne _"They got Hoyre! My friend! You will be avenged!"}
        {MSG_Hoyre _"I am alive, but I must run away! They try to kill me!"}
        {MSG_Cryne _"Run away? You are an Akladian Lord, stay and fight!"}
        {MSG_Hoyre _"Fortunately I have a hideout here..."}
        [kill]
            id="Hoyre O Barnone"
        [/kill]
        {MSG_unit _"Where is he? He must have hid somewhere!"}
    [/event]

    [event]
        # This is actually impossible in normal play, as Hoyre is scripted to run away when Player gets close, and then also to run away if he is attacked.
        # The player could still be cheating via debug mode, or something, though...
        name=last breath
        [filter]
            id="Hoyre O Barnone"
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        {MSG_Hoyre _"Argh! I am wounded!"}
        {MSG_Cryne _"They got Hoyre! My friend! You will be avenged!"}
        {MSG_Uri _"No, he is not dead, he is just heavily wounded and has lost consciousness!"}
        {MSG_narrator _"How did you manage to kill Hoyre? This shouldn't happen... Hoyre was supposed to run away when approached. Contact the maintainers with your savegame and replay for review!"}
    [/event]

    # Error handlers for player somehow managing to kill Bor Cryne and/or Uri van Roe:
    [event]
        name=die
        [filter]
            id=Bor Cryne
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
#ifdef DEBUG_MODE
        # Double-up on the checks to be sure:
        {IF_DEBUG_MODE_IS_ACTUALLY_ON}
        #po: Bor Cryne shouldn't die either way, whether debug mode is on or not, so the fact that we recognize debug mode specially here is just an easter egg:
        {MSG_narrator _"Using debug mode to kill Bor Cryne is cheating!"}
        {ELSE}
        {MSG_narrator _"It appears that debug mode either is on, or has been on in the past, so it's not clear if you're cheating to kill Bor Cryne or not... better restart just to be sure!"}
        {END_IF}
#else
        {MSG_narrator _"How did you manage to kill Bor Cryne? This shouldn't happen... it means the level is too easy. Stop what you are doing and contact the maintainers with your savegame and replay for review!"}
        [if]
            [have_unit]
                id=Bor Cryne
            [/have_unit]
            [then]
                [heal]
                    [filter]
                        id=Bor Cryne
                    [/filter]
                    amount=full
                    animate=yes
                    moves=full
                    restore_attacks=yes
                [/heal]
            [/then]
        [/if]
#endif
    [/event]

    [event]
        name=die
        [filter]
            id=Bor Cryne
        [/filter]
        [filter_second]
            side=2
        [/filter_second]
        #po: This ought to be impossible, but just in case:
        {MSG_narrator _"How did Hoyre manage to kill Bor Cryne? This shouldn't happen... it means something went wrong. Contact the maintainers with your savegame and replay for review!"}
    [/event]

    [event]
        name=die
        [filter]
            id=Bor Cryne
        [/filter]
        [filter_second]
            [not]
            [/not]
            # debug mode kills are implemented as a self-kill, apparently:
            [or]
                side=3
            [/or]
        [/filter_second]
#ifdef DEBUG_MODE
        {IF_DEBUG_MODE_IS_ACTUALLY_ON}
        # (same string as before; no additional comment)
        {MSG_narrator _"Using debug mode to kill Bor Cryne is cheating!"}
        {ELSE}
        {MSG_narrator _"It appears that debug mode either is on, or has been on in the past, so it's not clear if you're cheating to cause Bor Cryne to die or not... better restart just to be sure!"}
        {END_IF}
#else
        {MSG_narrator _"How did Bor Cryne manage to die? This shouldn't happen... it means something went wrong. Contact the maintainers with your savegame and replay for review!"}
#endif
    [/event]

    [event]
        name=die
        [filter]
            id=Uri van Roe
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
#ifdef DEBUG_MODE
        {IF_DEBUG_MODE_IS_ACTUALLY_ON}
        #po: Uri van Roe shouldn't die either way, whether debug mode is on or not, so the fact that we recognize debug mode specially here is just an easter egg:
        {MSG_narrator _"Using debug mode to kill Uri van Roe is cheating!"}
        {ELSE}
        {MSG_narrator _"It appears that debug mode either is on, or has been on in the past, so it's not clear if you're cheating to kill Uri van Roe or not... better restart just to be sure!"}
        {END_IF}
#else
        {MSG_narrator _"How did you manage to kill Uri van Roe? This shouldn't happen... it means the level is too easy. Contact the maintainers with your savegame and replay for review!"}
        [if]
            [have_unit]
                id=Uri van Roe
            [/have_unit]
            [then]
                [heal]
                    [filter]
                        id=Uri van Roe
                    [/filter]
                    amount=full
                    animate=yes
                    moves=full
                    restore_attacks=yes
                [/heal]
            [/then]
        [/if]
#endif
    [/event]

    [event]
        name=die
        [filter]
            id=Uri van Roe
        [/filter]
        [filter_second]
            side=2
        [/filter_second]
        #po: This ought to be impossible, but just in case:
        {MSG_narrator _"How did Hoyre manage to kill Uri van Roe? This shouldn't happen... it means something went wrong. Contact the maintainers with your savegame and replay for review!"}
    [/event]

    [event]
        name=die
        [filter]
            id=Uri van Roe
        [/filter]
        [filter_second]
            [not]
            [/not]
            # debug mode kills are implemented as a self-kill, apparently:
            [or]
                side=4
            [/or]
        [/filter_second]
#ifdef DEBUG_MODE
        {IF_DEBUG_MODE_IS_ACTUALLY_ON}
        # (same string as before; no additional comment)
        {MSG_narrator _"Using debug mode to kill Uri van Roe is cheating!"}
        {ELSE}
        {MSG_narrator _"It appears that debug mode either is on, or has been on in the past, so it's not clear if you're cheating to cause Uri van Roe to die or not... better restart just to be sure!"}
        {END_IF}
#else
        {MSG_narrator _"How did Uri van Roe manage to die? This shouldn't happen... it means something went wrong. Contact the maintainers with your savegame and replay for review!"}
#endif
    [/event]

    # Extra defenses for Uri van Roe:
    [event]
        name=moveto
        # FIXME: what if Uri has moved out of this zone in his attack on Barnon?
        # If the player is trying to capture villages he left behind after his attack,
        # that's not exactly "coming for me" (from his perspective), it's more like
        # running away from him... may need to adjust filter, or the dialogue, or something.
        [filter]
            side=1
            x=24-40
            y=31-40
        [/filter]
#ifdef URI_HAS_RESERVES
        #po: unused:
        {MSG_Uri _"Ah! He's coming for me! Time to use my reserves!"}
        [gold] # Players reported that they do not like this
            side=4
            amount={ON_DIFFICULTY4 100 140 180 220}
        [/gold]
        [unit]
            type=Akladian Darknite
            side=4
            x=38
            y=35
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                {TRAIT_STRONG}
#endif
            [/modifications]
        [/unit]
        [unit]
            type=Akladian Darknite
            side=4
            x=36
            y=35
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                {TRAIT_STRONG}
#endif
            [/modifications]
        [/unit]
        [unit]
            type=Akladian Darknite
            side=4
            x=37
            y=34
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                {TRAIT_STRONG}
#endif
            [/modifications]
        [/unit]
        [scroll_to]
            x,y=37,34
        [/scroll_to]
        [redraw]
        [/redraw]
        [delay]
            time=500
        [/delay]
        # ...and the moral is: don't get too smart and when you are told to escape, escape.
#else
        # FIXME: what if the player is using debug mode to trigger this event before Uri has turned on you?
        {MSG_Uri _"Ah! He's coming for me! What happened to my reserves?!"}
        # This variable is for the turn 15 event above:
        {VARIABLE_OP ano_uri_warned add 1}
        # ...he can still have a LITTLE more gold in this case:
        [gold]
            side=4
            amount={ON_DIFFICULTY4 10 20 30 40}
        [/gold]
#endif
        {MSG_Reme _"My lord, we really should try to escape, this battle is impossible to win!"}
        [event]
            name=attack
            [filter_second]
                id=Uri van Roe
            [/filter_second]
            {MSG_Uri _"Here are my reserves!"}
            # on NIGHTMARE there is code that tests this against things other than 1:
            {VARIABLE_OP ano_uri_warned add 1}
            [gold]
                side=4
                amount={ON_DIFFICULTY4 100 140 180 220}
            [/gold]
            [unit]
                type=Akladian Darknite
                side=4
                x=38
                y=35
                [modifications]
                    {TRAIT_LOYAL}
                    {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                    {TRAIT_STRONG}
#endif
                [/modifications]
            [/unit]
            [unit]
                type=Akladian Darknite
                side=4
                x=36
                y=35
                [modifications]
                    {TRAIT_LOYAL}
                    {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                    {TRAIT_STRONG}
#endif
                [/modifications]
            [/unit]
            [unit]
                type=Akladian Darknite
                side=4
                x=37
                y=34
                [modifications]
                    {TRAIT_LOYAL}
                    {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                    {TRAIT_STRONG}
#endif
                [/modifications]
            [/unit]
            [scroll_to]
                x,y=37,34
            [/scroll_to]
            [redraw]
            [/redraw]
            [delay]
                time=500
            [/delay]
            # ...and the moral is: don't attack enemy leaders you're not supposed to attack
        [/event]
    [/event]

    # Extra defenses for Bor Cryne:
    [event]
        name=moveto
        [filter]
            side=1
            x=1-12
            y=25-40
        [/filter]
        # Removed due complaints from players; I considered bringing this back for NIGHTMARE,
        # but then the dialogue would need to be changed and stuff...
#ifdef BOR_HAS_RESERVES
        #po: unused:
        {MSG_Cryne _"Ha! Come and get some! I have some nasty surprises for you!"}
        [gold] # Players reported they do not like this
            side=3
            amount={ON_DIFFICULTY4 100 140 180 220}
        [/gold]
        [unit]
            type=Akladian Darknite
            side=3
            x=4
            y=30
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                {TRAIT_STRONG}
#endif
            [/modifications]
        [/unit]
        [unit]
            type=Akladian Darknite
            side=3
            x=5
            y=30
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                {TRAIT_STRONG}
#endif
            [/modifications]
        [/unit]

        [scroll_to]
            x,y=4,30
        [/scroll_to]
        [redraw]
        [/redraw]
        [delay]
            time=500
        [/delay]
        [unit]
            type=Akladian Darknite
            side=3
            x=2
            y=22
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                {TRAIT_STRONG}
#endif
            [/modifications]
        [/unit]
#ifdef EASY
        [redraw][/redraw]
#else
        # this was the same on both NORMAL and HARD (and would also be on NIGHTMARE),
        # so I merged them into a single branch of this ifdef:
        [unit]
            type=Akladian Darknite
            side=3
            x=1
            y=22
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                {TRAIT_STRONG}
#endif
            [/modifications]
        [/unit]
#endif
        [scroll_to]
            x,y=2,22
        [/scroll_to]
        [redraw]
        [/redraw]
        [delay]
            time=500
        [/delay]
        # ...and the moral is: don't get too smart and when you are told to escape, escape.
#else
        # FIXME: what if the player is using debug mode to trigger this event before Bor Cryne has turned on you?
        {MSG_Cryne _"Ha! Come and get some! I'm more than ready for you!"}
        # ...he can still have a LITTLE more gold in this case:
        [gold]
            side=3
            amount={ON_DIFFICULTY4 10 20 30 40}
        [/gold]
#endif
        {MSG_Reme _"My lord, we really should try to escape, this battle is impossible to win!"}
        [event]
            name=attack
            [filter_second]
                id=Bor Cryne
            [/filter_second]
            {MSG_Cryne _"Time for some nasty surprises for you!"}
            [gold]
                side=3
                amount={ON_DIFFICULTY4 100 140 180 220}
            [/gold]
            [unit]
                type=Akladian Darknite
                side=3
                x=4
                y=30
                [modifications]
                    {TRAIT_LOYAL}
                    {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                    {TRAIT_STRONG}
#endif
                [/modifications]
            [/unit]
            [unit]
                type=Akladian Darknite
                side=3
                x=5
                y=30
                [modifications]
                    {TRAIT_LOYAL}
                    {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                    {TRAIT_STRONG}
#endif
                [/modifications]
            [/unit]

            [scroll_to]
                x,y=4,30
            [/scroll_to]
            [redraw]
            [/redraw]
            [delay]
                time=500
            [/delay]
            [unit]
                type=Akladian Darknite
                side=3
                x=2
                y=22
                [modifications]
                    {TRAIT_LOYAL}
                    {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                    {TRAIT_STRONG}
#endif
                [/modifications]
            [/unit]
#ifdef EASY
            [unit]
                type=Akladian Clansman
                side=3
                x,y=3,22
                [modifications]
                    {TRAIT_SLOW}
                    {TRAIT_DIM}
                [/modifications]
            [/unit]
#else
            [unit]
                type=Akladian Darknite
                side=3
                x=3
                y=22
                [modifications]
                    {TRAIT_LOYAL}
                    {TRAIT_RESILIENT}
#ifdef NIGHTMARE
                    {TRAIT_STRONG}
#endif
                [/modifications]
            [/unit]
#endif
            [scroll_to]
                x,y=2,22
            [/scroll_to]
            [redraw]
            [/redraw]
            [delay]
                time=500
            [/delay]
            # ...and the moral is: don't attack enemy leaders you're not supposed to attack
        [/event]
    [/event]

    # The actual part where Hoyre escapes:
    [event]
        name=moveto
        id=Hoyre_escapes
        [filter]
            side=1
            x=17-24
            y=1-6
        [/filter]
        {MSG_Hoyre _"My faithful warriors, it's time to show your loyalty to the clan!"}
        # These are the faithful warriors:
        {IF_NOT_HAVE_CREATE_LOYAL 2 (Akladian Warrior) 19 4}
        {IF_NOT_HAVE_CREATE_LOYAL 2 (Akladian Warrior) 18 4}
        {IF_NOT_HAVE_CREATE_LOYAL 2 (Akladian Warrior) 18 5}
        {IF_NOT_HAVE_CREATE_LOYAL 2 (Akladian Warrior) 19 6}
        {IF_NOT_HAVE_CREATE_LOYAL 2 (Akladian Warrior) 20 4}
        {IF_NOT_HAVE_CREATE_LOYAL 2 (Akladian Warrior) 20 5}
#ifdef NIGHTMARE
        # also put them on nearby villages:
        {IF_NOT_HAVE_CREATE_LOYAL 2 (Akladian Warrior) 22 4}
        {IF_NOT_HAVE_CREATE_LOYAL 2 (Akladian Warrior) 24 5}
        {IF_NOT_HAVE_CREATE_LOYAL 2 (Akladian Warrior) 24 3}
        {IF_NOT_HAVE_CREATE_LOYAL 2 (Akladian Warrior) 26 1}
        {IF_NOT_HAVE_CREATE_LOYAL 2 (Akladian Warrior) 20 7}
        {IF_NOT_HAVE_CREATE_LOYAL 2 (Akladian Warrior) 18 8}
#endif

        [hide_unit]
            id="Hoyre O Barnone"
        [/hide_unit]
        [move_unit_fake]
            side=2
            type=Akladian Lord
            x=19,20,21,22,23,24,25,26,27,27,27
            y=5, 5, 5, 5 ,5, 4, 4, 3, 3, 2 , 1
        [/move_unit_fake]
        [teleport]
            [filter]
                id="Hoyre O Barnone"
            [/filter]
            x,y=27,1
        [/teleport]
        [unhide_unit]
            id="Hoyre O Barnone"
        [/unhide_unit]

        {MSG_Hoyre _"Do not worry, I will soon be back, with reinforcements!"}
#ifdef NIGHTMARE
        [store_unit]
            [filter]
                id="Hoyre O Barnone"
            [/filter]
            variable=ano_barnon_Hoyre_tmp
            kill=yes
        [/store_unit]
#else
        [kill]
            id="Hoyre O Barnone"
        [/kill]
#endif
        [modify_side]
            side=2
            [ai]
                # Hoyre's units take after their lord; make them more likely to retreat:
                retreat_factor={ON_DIFFICULTY4 0.9 0.8 0.7 0.6}
                retreat_enemy_weight={ON_DIFFICULTY4 1.8 1.6 1.4 1.2}
                grouping=no
            [/ai]
        [/modify_side]
        #po: I'm guessing Bor Cryne is wondering if Hoyre's mother was actually Wesnothian?
        {MSG_Cryne _"This Hoyre... Sometimes I wonder whether his mother... It seems, Uri, that we will have to finish this on our own."}
        # Give some extra gold to the other leaders to make up for the fact that their team is down one leader now:
        [gold]
            side=3 # Bor Cryne
            amount={ON_DIFFICULTY4 20 30 40 50}
        [/gold]
        [gold]
            side=4 # Uri van Roe
            amount={ON_DIFFICULTY4 10 20 30 40}
        [/gold]
        [redraw][/redraw]
        # ...uh... strange things start to happen after this if you use debug mode to trigger this event before your "allies" have turned on you...
        # Let's see if this helps:
        [if]
            [variable]
                name=ano_barnon_tr
                equals=no
            [/variable]
            [then]
                {MSG_Uri _"...well, now that Hoyre's no longer around, there's no need to keep up this farce, is there, Bor?"}
                [modify_side]
                    side=4
                    team_name=bad
                [/modify_side]

                {REPLACE_SCENARIO_MUSIC theme_of_a_new_order.ogg}
                {MSG_Cryne _"Indeed, Uri, there isn't! Let our swords instead cut that underling's head off! And slay that witch, his step-mother, as well!"}
                [modify_side]
                    side=3
                    team_name=bad
                [/modify_side]
                {APPEND_MUSIC battle/onethousandsuns.ogg}
                {APPEND_MUSIC battle/battlecry.ogg}
                {APPEND_MUSIC battle/gameplay06.ogg}
                {APPEND_MUSIC siege_of_laurelmor.ogg}
                {APPEND_MUSIC battle-epic.ogg}
                # This macro (ANO4_TRAITORS) is defined in ano-01_06macros.cfg and contains most of the dialogue that occurs here:
                {ANO4_TRAITORS _"Reach either the eastern or western signpost with both Lorin AND Reme. After that, hold on at least $ano_howmanyturns turns before the honorable death of Gawen Hagarthen."}
            [/then]
        [/if]
        # (ok after testing, yup, it does indeed help)
#ifdef NIGHTMARE
        [event]
            # delayed_variable_substitution=no gets the event to fire, but it also means that other dollar-sign usages might not work:
            delayed_variable_substitution=no
            name="turn $($turn_number + 6)"
            id=Hoyre_returns
            [scroll_to]
                x,y=27,1
            [/scroll_to]
            [unstore_unit]
                variable=ano_barnon_Hoyre_tmp
                x,y=27,1
                find_vacant=yes
            [/unstore_unit]
            [modify_unit]
                [filter]
                    id="Hoyre O Barnone"
                [/filter]
                # There's already a F_C_T_H above that ought to keep him safe, but just in case:
                [status]
                    unpoisonable=yes
                    undrainable=yes
                    unplagueable=yes
                    invulnerable=yes
                [/status]
            [/modify_unit]
            [redraw][/redraw]
            {MSG_Hoyre _"I'm back with the reinforcements, just as promised!"}
            # Fire this as a separate event due to this one using delayed_variable_substitution=no above:
            [fire_event]
                # Tee hee hee I'm evil:
                name=timeover_reinforcements
            [/fire_event]
            {CLEAR_VARIABLE ano_barnon_Hoyre_tmp}
        [/event]
#endif
    [/event]

    # Put out here so it can be called from elsewhere:
    [event]
        name=timeover_reinforcements
        id=timeover_reinforcements
        {ANO4_TIMEOVER_REINFORCEMENTS} # defined in ano-01_06macros.cfg
    [/event]

    # Easter egg:
    [event]
        name=moveto
        [filter]
            side=1
            x,y=39,37 # Uri's original keep
        [/filter]
        {VARIABLE gold_amt {ON_DIFFICULTY4 60 50 40 30}}
        {MSG_unit _"Ha! It seems Uri left behind some gold here after setting out from this encampment!"}
        {MSG_narrator _"You have received $gold_amt gold pieces."}
        [gold]
            side=1
            amount=$gold_amt
        [/gold]
        {MSG_Uri _"Now wait just a minute here! Men, look around and see if they dropped any of their own gold!"}
        #po: Bor Cryne's response here assumes that Uri is still alive (which he ought to be) and said his line:
        {MSG_Cryne _"Yes, gold for all true Akladians!"}
        {MSG_narrator _"Bor Cryne and Uri van Roe have each received $gold_amt gold pieces."}
        [gold]
            side=3,4
            amount=$gold_amt
        [/gold]
        {CLEAR_VARIABLE gold_amt}
    [/event]

    # The events below do not work properly... and szopen mistakenly deleted the
    # version with working events. Bor Cryne should complain if some
    # Gawen's soldiers were killed, then player reloaded the game and in next
    # turn previously killed unit was alive (it happens when player reloads
    # until he can get lucky)
    # Problem is that in fact player may in one turn attack, lose unit,
    # and in another turn he may just choose another strategy...
    [event]
        name=reload to the previous turn to avoid losses
        {VARIABLE ano_tmp_turn $turn_number}
        {VARIABLE_OP ano_tmp_turn add 1}
        {VARIABLE ano_reload true}
    [/event]

    [event]
        name=new turn
        first_time_only=false
        {IF turn_number equals $ano_tmp_turn}
        {IF ano_first_time equals true}
        {IF ano_reload equals true}
        {ANO_GLOBAL_VARIABLE_TO_LOCAL ano_barnon_dejavu_lastkilled_type tmp}
        {IF_HAVE_UNIT_TYPE ($tmp)}
        {VARIABLE tmpg _"yet he is still alive"}
        {IF tmp equals "Akladian Pikeneer"}
        #po: I was so sure our warriors will kill that
        {VARIABLE tmp _"pikeneer"}
        {ELSE_IF tmp equals "Akladian Protector"}
        #po: I was so sure our warriors will kill that
        {VARIABLE tmp _"protector"}
        {ELSE_IF tmp equals "Akladian Clansman"}
        #po: I was so sure our warriors will kill that
        {VARIABLE tmp _"clansman"}
        {ELSE_IF tmp equals "Akladian Shieldguard"}
        #po: I was so sure our warriors will kill that
        {VARIABLE tmp _"shieldguard"}
        {ELSE_IF tmp equals "Akladian Homeguard"}
        #po: I was so sure our warriors will kill that
        {VARIABLE tmp _"homeguard"}
        {ELSE_IF tmp equals "Akladian Raider"}
        #po: I was so sure our warriors will kill that
        {VARIABLE tmp _"raider"}
        {ELSE_IF tmp equals "Akladian Light Infantry"}
        #po: I was so sure our warriors will kill that
        {VARIABLE tmp _"light infantryman"}
        {ELSE_IF tmp equals "Akladian Warrior"}
        #po: I was so sure our warriors will kill that
        {VARIABLE tmp _"warrior"}
        {ELSE_IF tmp equals "Akladian Fastfoot"}
        #po: I was so sure our warriors will kill that
        {VARIABLE tmp _"fastfoot"}
        {ELSE_IF tmp equals "Hagarthen"}
        #po: I was so sure our warriors will kill that
        {VARIABLE tmp _"underling"}
        {ELSE_IF tmp equals "Lord Hagarthen"}
        #po: I was so sure our warriors will kill that
        {VARIABLE tmp _"underling"}
        {ELSE_IF tmp equals "Young Hagarthen"}
        #po: I was so sure our warriors will kill that
        {VARIABLE tmp _"underling"}
        {ELSE_IF tmp equals "Akladian Lady"}
        #po: I was so sure our warriors will kill that
        {VARIABLE tmp _"witch, his stepmother"}
        {VARIABLE tmpg _"yet she is still alive"}
        {ELSE_IF tmp equals "Akladian Princess"}
        #po: I was so sure our warriors will kill that
        {VARIABLE tmp _"witch, his stepmother"}
        {VARIABLE tmpg _"yet she is still alive"}
        {ELSE_IF tmp equals "Akladian Queen"}
        #po: I was so sure our warriors will kill that
        {VARIABLE tmp _"witch, his stepmother"}
        {VARIABLE tmpg _"yet she is still alive"}
        {ELSE}
        #po: I was so sure our warriors will kill that
        {VARIABLE tmp _"warrior"}
        {EIGHT_END_IFs}
        {FOUR_END_IFs}
        {TWO_END_IFs}
        {END_IF}

        {MSG_Cryne _"This underling has incredible luck!"}
        {MSG_Uri _"What do you mean, Bor?"}
        {MSG_Cryne _"I don't know how to explain this. But... For example, I was so sure our warriors will kill that $tmp, $tmpg|!"}
        {CLEAR_VARIABLE tmpg}
        {END_IF_WITHOUT_ELSE}
        {END_IF_WITHOUT_ELSE}
        {END_IF_WITHOUT_ELSE}
        {ELSE}
        # ???
        {END_IF}
    [/event]
[/scenario]

#undef END_OF_BARNON_CLEANUP
